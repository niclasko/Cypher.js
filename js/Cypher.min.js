function DB(){function u(){var o=[{},null],s=1;this.recode=function(t){if(!t)return t;var e=t;e.charAt||(e=""+t);for(var n,i=o,r=0;r<e.length;r++)n=e.charAt(r),i[0][n]||(i[0][n]=[{},null]),i=i[0][n];return i[1]||(i[1]=s++)}}function t(){var t=-1;this.getId=function(){return t++}}function e(h){var V=[],f=0,T={},D={},j=[],l=0,i={},n={},d={},p={},e=new u,C=(new t,function(t){return e.recode(t)}),r=function(t,e){null!=t&&(i[t]||(i[t]={}),null!=e&&(i[t][e]||(i[t][e]=[])))},g=function(t,e){if(r(t,e),null!=t){if(null!=e)return i[t][e];if(null==e){var n=[];for(nodeId in i[t])n=n.concat(i[t][nodeId]);return n}}return[]},v=function(t,e,n){r(t,e),i[t][e].push(n),o(t,n)},y=function(t){return n[t]},o=function(t,e){n[t]||(n[t]=[]),n[t].push(e)},k=function(t,e){T[t]||(T[t]={}),T[t][e]||(T[t][e]=[])},w=function(t,e){d[t]||(d[t]={}),d[t][e]||(d[t][e]=[])},M=function(t){D[t]||(D[t]=[])},x=function(t){if(!p[t])return!(p[t]=[])},S=function(t,e){if(e){if(e){if(V[e])throw"Node with ID "+e+" already exists in the database.";t.setId(e),V[e]=t}}else t.setId(function(){for(;V[f];)f++;return f}()),V[t.id()]=t;for(key in t.getRawProperties())n=key,i=t.getLocalProperty(key),r=t.id(),void 0,o=C(n),s=C(i),k(o,s),T[o][s].push(r);var n,i,r,o,s,u,a,c;for(label in t.labels())u=label,a=t.id(),void 0,c=C(u),M(c),D[c].push(a);h.statement().setNodesAdded(h.statement().getNodesAdded()+1)},K=function(t,e){if(e){if(e){if(V[e])throw"Relationship with ID "+e+" already exists in the database.";t.setId(e),t[e]=t}}else t.setId(function(){for(;j[l];)l++;return l}()),j[t.id()]=t;for(key in(t.rightDirection()||t.noDirection()||t.uniDirectional())&&v(t.getFromNode().id(),t.getToNode().id(),t.id()),(t.leftDirection()||t.uniDirectional())&&v(t.getToNode().id(),t.getFromNode().id(),t.id()),t.getProperties())n=key,i=t.getProperty(key),r=t.id(),void 0,o=C(n),s=C(i),w(o,s),d[o][s].push(r);var n,i,r,o,s,u,a,c;u=t.getType(),a=t.id(),c=C(u),x(c),p[c].push(a),t.setIsAdded(),h.statement().setRelationshipsAdded(h.statement().getRelationshipsAdded()+1)},G=function(t,e,n){var i,r=[];if(t.isReferred()?t.isReferred()&&r.push(t.getReferredRelationship().getData().id()):((t.rightDirection()||t.noDirection()||t.uniDirectional())&&(e&&n?(i=g(e.id(),n.id()))&&(r=r.concat(i)):e&&!n&&(i=y(e.id()))&&(r=r.concat(i))),(t.leftDirection()||t.uniDirectional())&&(n&&e?(i=g(n.id(),e.id()))&&(r=r.concat(i)):n&&!e&&(i=y(n.id()))&&(r=r.concat(i)))),0==r.length)return!1;var o,s=0,u=0,a={},c=[],h=function(t){a[t]=a[t]?a[t]+1:1,a[t]>u&&(u=a[t])};for(key in t.getType()&&s++,t.getProperties())s++;for(var f=0;f<r.length;f++)for(key in o=j[r[f]],0==s&&c.push(r[f]),t.getType()&&o.getType()&&o.getType()==t.getType()&&h(r[f]),t.getProperties())t.getProperty(key)==o.getProperty(key)&&h(r[f]);if(u==s&&0<s)for(var l in a)a[l]==u&&c.push(l);return 0!=c.length&&c};this.matchNode=function(e,n,t){var i,r,o,s,u,a,c=function(t){if(e.nextNode()){if(e.getPattern().usedAsCondition())return e.nextNode().convey(n,t);e.nextNode().convey(n,t)}else if(!e.nextNode()){if(e.getPattern().usedAsCondition())return e.nextAction();e.nextAction()}},h=[];if(e.isExpanded())e.isExpanded()&&(h=[e.getExpandedNode().id()]);else{var f,l=0,d={},p=[],g=function(t){p.push(parseInt(t))},v=function(){for(var t in p=[],d)d[t]==l&&g(t)},y=function(){l++};e.isReferred()&&g(e.getReferredNode().getData().id());var w,x=function(t){d[t]=d[t]+1||1};if(e.incomingRelationship())if(O=e.incomingRelationship().getMatchingRelationshipIds())for(var b=0;b<O.length;b++)x((w=j[O[b]]).getToNode().id()),e.addMatchedIncomingRelationshipId(w.getToNode().id(),w.id()),0==b&&y(),v();for(key in e.getProperties()){if(e.bindProperty(key),0==l&&0==p.length){if(o=key,s=e.getLocalProperty(key),void 0,u=C(o),a=C(s),k(u,a),f=T[u][a])for(b=0;b<f.length;b++)x(f[b])}else if(0<p.length)for(b=0;b<p.length;b++)e.getLocalProperty(key)==V[p[b]].getLocalProperty(key)&&x(p[b]);y(),v()}for(label in e.labels()){if(0==l&&0==p.length){if(i=label,void 0,r=C(i),M(r),f=D[r])for(b=0;b<f.length;b++)x(f[b])}else if(0<p.length)for(b=0;b<p.length;b++)V[p[b]].hasLabel(label)&&x(p[b]);y(),v()}if(0<l&&0==p.length){if(n){var m=e.copy();if(S(m),addedNode=!0,e.addMatchedNode(m),e.incomingRelationship()){e.incomingRelationship().bindProperties(),e.incomingRelationship().setToNode(m);var R=e.incomingRelationship().copy();K(R),e.incomingRelationship().addMatchedRelationship(R)}e.outgoingRelationship()&&e.outgoingRelationship().setFromNode(m),c()}}else if(0<p.length)h=p;else if(0==l){h=new Array(V.length);for(b=0;b<V.length;b++)h[b]=V[b].id()}}for(var N=0;N<h.length;N++){var E,P=h[N];if(!e.incomingRelationship()&&!e.outgoingRelationship()){if(e.addMatchedNode(V[P]),e.getPattern().usedAsCondition())return c();c()}if(e.outgoingRelationship()){t||e.addMatchedNode(V[P]),e.outgoingRelationship().setFromNode(V[P]);var O,I=null;if(e.outgoingRelationship().getNextObject().isReferred()&&(I=e.outgoingRelationship().getNextObject().getReferredNode().getData()),O=G(e.outgoingRelationship(),e.outgoingRelationship().getFromNode(),I)){if(O)for(var A=0;A<O.length;A++){if(e.outgoingRelationship().setMatchingRelationshipIds([O[A]]),e.getPattern().usedAsCondition())return c();c()}}else{if(e.getPattern().usedAsCondition())return c();c()}}if(e.incomingRelationship())if(e.addMatchedNode(V[P]),e.isReferred()||e.isExpanded()?(e.isReferred()||e.isExpanded())&&(E=e.incomingRelationship().getMatchingRelationshipIds()):E=e.getMatchedIncomingRelationshipIds(P),!E&&n){e.incomingRelationship().bindProperties(),e.incomingRelationship().setToNode(V[P]);R=e.incomingRelationship().copy();if(K(R),e.incomingRelationship().addMatchedRelationship(R),e.getPattern().usedAsCondition())return c();c()}else if(E||n){if(E&&0<E.length)for(var B=0;B<E.length;B++){var L=E[B];j[L].getToNode().id();if(e.incomingRelationship().addMatchedRelationship(j[L]),e.incomingRelationship().pathLengthSatisfied()&&!e.incomingRelationship().visitedBefore(L)){if(e.getPattern().usedAsCondition())return c();c()}if(e.incomingRelationship().expandPath())e.incomingRelationship().getPreviousObject().setExpandedNode(V[P]),e.incomingRelationship().visitedBefore(L)||this.matchNode(e.incomingRelationship().getPreviousObject(),!1,(t||0)+1),e.incomingRelationship().backTrackExpandedPath(),e.incomingRelationship().getPreviousObject().setExpandedNode(null);else{if(e.getPattern().usedAsCondition())return c();c()}}}else;}if(e.getPattern().usedAsCondition())return!1},this.getNodeById=function(t){return V[t]},this.getRelationshipById=function(t){return j[t]},this.addNode=function(t){var e=new Ae(this);e.setProperties(t.properties),e.setLabels(t.labels),S(e,t.id)},this.addRelationship=function(t){var e=new Be(Fe);e.setFromNode(this.getNodeById(t.from)),e.setToNode(this.getNodeById(t.to)),e.setProperties(t.properties),e.setType(t.type),K(e,t.id)}}function Ae(t){var e,n,i,r,o,s=t,u={},a={},c={},h=!1,f=!1,l=null,d=null,p=this,g=!1;this.setPreviousObject=function(t){i=t},this.getPreviousObject=function(){return i},this.setNextObject=function(t){r=t},this.getNextObject=function(){return r},this.setPattern=function(t){o=t},this.getPattern=function(){return o},this.nextNode=function(){if(p.getNextObject()){if(p.getNextObject().isRelationship())return p.getNextObject().getNextObject();if(p.getNextObject().isNode())return p.getNextObject()}return null},this.previousNode=function(){if(p.getPreviousObject()){if(p.getPreviousObject().isRelationship())return p.getPreviousObject().getPreviousObject();if(p.getPreviousObject().isNode())return p.getPreviousObject()}return null},this.incomingRelationship=function(){return p.getPreviousObject()&&p.getPreviousObject().isRelationship()?p.getPreviousObject():null},this.outgoingRelationship=function(){return p.getNextObject()&&p.getNextObject().isRelationship()?p.getNextObject():null},this.setId=function(t){e=t},this.id=function(){return e},this.getId=this.id,this.setProperty=function(t,e){c[t]=null,a[t]=e.value},this.setProperties=function(t){for(var e in t)c[e]=t[e]},this.bindProperty=function(t){c[t]=a[t]()},this.bindProperties=function(){for(var t in c)this.bindProperty(t)},this.setLabel=function(t){u[t]=!0},this.hasLabel=function(t){return u[t]},this.setLabels=function(t){for(var e in t)u[e]=t[e]},this.setVariableKey=function(t){n=t},this.getVariableKey=function(){return n},this.hasVariableKey=function(){return null!=n},this.getProperties=function(){return Object.create(c)},this.getRawProperties=function(){return c},this.labels=function(){return u},this.getLabels=function(){return Object.keys(u)},this.hasLabels=function(){return 0<Object.keys(u).length},this.hasProperties=function(){return 0<Object.keys(c).length},this.setHasRightRelationship=function(t){h=t},this.setHasLeftRelationship=function(t){f=t},this.hasRelationship=function(){return h||f};var v,y=function(t){var e=this;for(var n in t)this[n]=t[n];this.getId=function(){return e.id},this.getData=function(){return e},this.getObject=function(){return e},this.groupByKey=function(){return e.id},this.groupByValue=function(){return e}};this.get=function(t){return t?e:new x(s,e)},this.toObject=function(){return new y({id:e,labels:this.getLabels(),properties:O(c),getProperty:function(){return c[key]},getProperties:function(){return this.properties},getKeys:function(){return this.properties.getKeys()}})},this.toString=function(){return JSON.stringify(this.get())},this.type=function(){return this.constructor.name},this.isRelationship=function(){return!1},this.isNode=function(){return!0},this.setReferredNode=function(t){l=t},this.isReferred=function(){return null!=l},this.getReferredNode=function(){return l},this.setExpandedIsMatched=function(){g=!0},this.expandedIsMatched=function(){return!!g&&!(g=!1)},this.setExpandedNode=function(t){d=t},this.isExpanded=function(){return null!=d},this.getExpandedNode=function(){return d},this.nextAction=function(){},this.setNextAction=function(t){this.nextAction=t},this.convey=function(t,e){return s.matchNode(p,t,e)};var w={};this.addMatchedNode=function(t){v=t.id()},this.getMatchedNode=function(){return this.getData()},this.addMatchedIncomingRelationshipId=function(t,e){w[t]||(w[t]=[]),w[t].push(e)},this.getMatchedIncomingRelationshipIds=function(t){if(!w[t])return null;var e=w[t];return w[t]=[],e},this.getData=function(){return s.getNodeById(v)},this.getLocalProperty=function(t){return c[t]||null},this.getProperty=function(t){return s.getNodeById(v)?s.getNodeById(v).getLocalProperty(t):null},this.groupByKey=function(){return this.getData().id()},this.groupByValue=function(){return this.getData().get()},this.copy=function(){var t=new Ae(s);return t.setLabels(u),t.setProperties(c),t.setHasRightRelationship(h),t.setHasLeftRelationship(f),t}}function Be(t){var e,n,i,r,o,s,u,a,c,h,f,l,d=t,p={},g={},v=!1,y=!1,w=1,x=1,b=null;this.setPreviousObject=function(t){h=t},this.getPreviousObject=function(){return h},this.setNextObject=function(t){f=t},this.getNextObject=function(){return f},this.setPattern=function(t){l=t},this.getPattern=function(){return l},this.setId=function(t){e=t},this.id=function(){return e},this.setType=function(t){n=t},this.getType=function(){return n},this.setProperty=function(t,e){p[t]=null,g[t]=e.value},this.bindProperty=function(t){p[t]=g[t]()},this.bindProperties=function(){for(var t in p)this.bindProperty(t)},this.setProperties=function(t){for(var e in t)p[e]=t[e]},this.getProperty=function(t){return p[t]},this.getProperties=function(){return p},this.setFromNode=function(t){i=t},this.setToNode=function(t){r=t},this.getFromNode=function(){return i},this.getToNode=function(){return r},this.setFromNodeId=function(t){o=t},this.setToNodeId=function(t){s=t},this.setFrom=function(t){o=(i=t).id()},this.setTo=function(t){s=(r=t).id()},this.getFromNodeId=function(){return o},this.getToNodeId=function(){return s},this.setLeftDirection=function(t){u=t},this.setRightDirection=function(t){a=t},this.leftDirection=function(){return u&&!a},this.rightDirection=function(){return a&&!u},this.uniDirectional=function(){return a&&u},this.noDirection=function(){return!u&&!a},this.type=function(){return this.constructor.name},this.isRelationship=function(){return!0},this.isNode=function(){return!1},this.setReferredRelationship=function(t){b=t},this.isReferred=function(){return null!=b},this.getReferredRelationship=function(){return b},this.isAdded=function(){return v},this.setIsAdded=function(){v=!0},this.setHasVariablePathLength=function(){y=!0,x=w=null},this.hasVariablePathLength=function(){return y},this.setPathLengthFrom=function(t){w=t},this.pathLengthFrom=function(){return w},this.setPathLengthTo=function(t){x=t},this.pathLengthTo=function(){return x},this.expandPath=function(){return y};var m,R=function(t){for(var e in t)this[e]=t[e];this.getId=function(){return this.id},this.getData=function(){return this},this.getObject=function(){return this},this.groupByKey=function(){return this.id},this.groupByValue=function(){return this}};this.get=function(){return new I(d,e)},this.toObject=function(){return new R({id:e,type:n,properties:O(p),fromNode:i?i.get():null,toNode:r?r.get():null,getProperty:function(){return p[key]},getProperties:function(){return this.properties},getKeys:function(){return this.properties.getKeys()},getType:function(){return n}})},this.value=function(){return this.get()},this.setVariableKey=function(t){c=t},this.getVariableKey=function(){return c},this.hasVariableKey=function(){return null!=c},this.nextAction=function(){},this.setNextAction=function(t){this.nextAction=t},this.visitedBefore=function(t){return 2==P[t]};var N,E=[],P={};this.addMatchedRelationship=function(t){var e;m=t.id(),y&&(e=t.id(),null==P[e]&&(P[e]=0),P[e]++,E.push(m))},this.getMatchedRelationship=function(){return this.getData()},this.setMatchingRelationshipIds=function(t){N=t},this.getMatchingRelationshipIds=function(){var t=null;return N&&(t=N.slice()),N=null,t},this.backTrackExpandedPath=function(){if(0!=E.length){var t=d.getRelationshipById(E.pop());0==E.length&&(P={}),delete P[t.id()]}},this.pathLengthFromSatisfied=function(){return!w||w&&E.length>=w},this.pathLengthToSatisfied=function(){return!x||x&&E.length<=x},this.pathLengthSatisfied=function(){return this.pathLengthFromSatisfied()&&this.pathLengthToSatisfied()},this.getData=function(){return y?new Te(E,function(t){return d.getRelationshipById(t).value()}):d.getRelationshipById(m)},this.getLocalProperty=function(t){return p[t]||null},this.getProperty=function(t){return d.getRelationshipById(m)?d.getRelationshipById(m).getLocalProperty(t):null},this.groupByKey=function(){return this.getData().id()},this.groupByValue=function(){return this.getData().get()},this.copy=function(){var t=new Be(d);return t.setType(n),t.setProperties(p),t.setLeftDirection(u),t.setRightDirection(a),t.setFromNode(i),t.setFromNodeId(o),t.setToNode(r),t.setToNodeId(s),t}}function Le(){var e=[],n=[],o=[],i=this,t=!1,r=function(t){i.empty()||(i.lastObject().setNextObject(t),t.setPreviousObject(i.lastObject())),t.setPattern(i),e.push(t)};this.addNode=function(t){n.push(t),r(t)},this.addRelationship=function(t){o.push(t),r(t)},this.getData=function(){for(var t,e,n=[],i=0;i<o.length;i++)if(o[i].hasVariablePathLength()){if(o[i].hasVariablePathLength()){e=o[i].getData().value();for(var r=0;r<e.length;r++)t=e[r].getRelationship(),n.push(t.getFromNode().get(),t.get(),t.getToNode().get())}}else t=o[i].getData().value().getRelationship(),n.push(t.getFromNode().get(),t.get(),t.getToNode().get());return(n=Ge(n)).getNodes=function(){for(var t=[],e=0;e<n.length;e+=3)0==e&&t.push(n[e]),t.push(n[e+2]);return Ge(t)},n.getRelationships=function(){for(var t=[],e=0;e<n.length;e+=3)t.push(n[e+1]);return Ge(t)},n},this.objects=function(){return e},this.getObject=function(t){return e[t]},this.lastObject=function(){return e[e.length-1]},this.getLast=this.lastObject,this.empty=function(){return 0==e.length},this.setNextAction=function(t){s=t};var s=function(){},u=function(){i.lastObject().setNextAction(function(){s()})};this.useAsCondition=function(){t=!0,i.lastObject().setNextAction(function(){return!0})},this.usedAsCondition=function(){return t},this.value=function(){return n[0].convey(!1)},this.match=function(){u(),n[0].convey(!1)},this.merge=function(){u(),n[0].convey(!0)}}function Ve(){var n={},i={},r=[],t=this,o=function(){for(var t in n)i[t]=n[t].value()};this.addEntry=function(t,e){if(t in n)throw'Key "'+t+'" already exists in associative array.';n[t]=e,i[t]=null,r.push(t)},this.get=function(){o();var t={};for(var e in i)t[e]=i[e],t[e].constructor=i[e].constructor;return O(t)},this.getProperty=function(t){return o(),i[t]},this.getProperties=function(){return Object.keys(n)},this.getValues=function(){return Object.values(n)},this.setValue=function(t,e){n[r[t]]=e},this.next=function(){return!1},this.hasNext=function(){return!0},this.reset=function(){},this.getData=function(){return t},this.getObject=function(){return t},this.value=function(){return t.get()},this.type=function(){return t.constructor.name},this.groupByKey=function(){return t.get()},this.groupByValue=function(){return t.get()}}function Te(i,r){i=i&&i.constructor==Array&&i||[];var o=Ge([]),t=this;this.add=function(t){t&&(i.push(t),o.push(null))},this.get=function(){!function(){if(r){if(r)for(t=0;t<i.length;t++)o[t]=r(i[t])}else for(var t=0;t<i.length;t++)o[t]=i[t].value()}();for(var t=new Array(o.length),e=0;e<o.length;e++)if(o[e].constructor!=x&&o[e].constructor!=I)for(var n in t[e]=o[e],t[e].constructor=o[e].constructor,o[e])t[e][n]&&(t[e][n].constructor=o[e][n].constructor);else t[e]=o[e];return Ge(t)},this.setElement=function(t,e){i[t]=e},this.getElements=function(){return i},this.next=function(){return!1},this.hasNext=function(){return!0},this.reset=function(){},this.getData=function(){return t},this.value=function(){return t.get()},this.type=function(){return t.constructor.name},this.groupByKey=function(){return t.get()},this.groupByValue=function(){return t.get()}}function De(){var e,t=this,n=[],i=[];this.when=function(t){n.push(t)},this.whenCount=function(){return n.length},this.then=function(t){i.push(t)},this.else=function(t){e=t},this.get=function(){return this.value()},this.next=function(){return!1},this.hasNext=function(){return!0},this.reset=function(){},this.getData=function(){return t},this.value=function(){for(var t=0;t<n.length;t++)if(n[t].value())return i[t].value();return e.value()},this.type=function(){return t.constructor.name},this.groupByKey=function(){return t.get()},this.groupByValue=function(){return t.get()}}function je(t){var e=t;this.get=function(){return e},this.next=function(){return!1},this.hasNext=function(){return!0},this.reset=function(){},this.getData=function(){return this},this.getObject=function(){return e},this.value=function(){return e},this.id=function(){return e.id},this.setValue=function(t){e=t},this.type=function(){return this.constructor.name},this.groupByKey=function(){return e},this.groupByValue=function(){return e}}var a=new function(){this.get=function(t,e,n){var i=function(){try{return new XMLHttpRequest}catch(t){}return new function(){this.UNSENT=0,this.OPENED=1,this.HEADERS_RECEIVED=2,this.LOADING=3,this.DONE=4,this.readyState=this.UNSENT,this.status=null,this.responseText=null,this.response=null,this.responseType=null,this.method=null,this.url=null,this.async=!0,this.onreadystatechange=function(){},this.onload=function(){},this.open=function(t,e,n){this.method=t,this.url=e,this.async=n,this.readyState=this.OPENED},this.send=function(){var t=null;try{t=require("https")}catch(t){}var n=this;t.get(this.url,function(t){var e="";t.on("data",function(t){e+=t}),t.on("end",function(){n.responseText=e,n.response=e,n.readyState=n.DONE,n.status=200,n.onreadystatechange()})}).on("error",function(t){console.log("Error: "+t),n.status=0,n.onreadystatechange()}),this.onload(this)}}}();i.onreadystatechange=function(){4==i.readyState&&(200==i.status?e(i.responseText):200!=i.status&&(0==i.status?n('Access denied for URL resource "'+t+'".'):404==i.status&&n('URL resource "'+t+'" not found.')))},i.open("GET",t,!0),i.send()}};function Ce(t,e,n,i,r){var o=t,s=o.element&&o.element().getKey?o.element().getKey():e,u=n,a=i,c=r;if(u){a.addReduceExpression(this);for(var h=0;h<u.length;h++)u[h].setGroupBy(a.getGroupBy()),u[h].setReducer(a.getGroupBy().addReducer()),u[h].initialize()}if(this.root=function(){return o},this.value=function(){return o.value()},this.getAlias=function(){return s},this.variableReferences=function(){return c},this.hasReferredVariables=function(){return c&&0<c.length},this.setAlias=function(t){t=t},this.hasKey=function(){return o.hasKey&&o.hasKey()},this.isReduceExpression=function(){return null!=u},this.aggregate=function(){if(u)for(var t=0;t<u.length;t++)u[t].aggregate();else a.getGroupBy().map(o)},this.hasAggregateFunctions=function(){return null!=u},this.isArray=function(){return o.element().constructor==Te},this.isAssociativeArray=function(){return o.element().constructor==Ve},this.getAggregateFunctions=function(){return u},this.type=function(){return this.constructor.name},o.element().constructor==Te){var f=o.element().getElements();for(h=0;h<f.length;h++)return void(f[h].hasAggregateFunctions&&(this.hasAggregateFunctions=function(){return!0}))}}function d(t,e){var n=t,i=e,r=null;this.getObjectKey=function(){return i},this.getObject=function(){return r||(n.constructor==je?n.getObject():n)},this.value=function(t){if(r)return r;try{return n.getData().get(t)}catch(t){}return null},this.setOverriddenValue=function(t){r=t}}function m(t){var e=t;this.evaluate=function(){return 1==e.value()}}function n(){var i,e;function r(t,e,n){var i=t,r=e,o=n;this.set=function(){var t=i.getObject();if(t.constructor==x){var e=t.getObject();e.setProperty(r,o),e.bindProperty(r)}else{if(t.constructor!=I)throw'Cannot assign to object of type "'+t.constructor.name+'".';var n=t.getObject();n.setProperty(r,o),n.bindProperty(r)}}}this.addSetter=function(t,e,n){i||(i=[]),i.push(new r(t,e,n))},this.setPreviousOperation=function(t){t},this.setNextOperation=function(t){(e=t).setPreviousOperation(this)},this.doIt=function(){for(var t=0;t<i.length;t++)i[t].set();e&&e.doIt()},this.finish=function(){e&&e.finish()},this.run=function(t){throw"Set-operation cannot be first in statement."},this.type=function(){return this.constructor.name}}function i(t){var e,n,i,r=t,o=[];this.where=function(t){i=new m(t)},this.addPattern=function(){o.push(new Le)};var s=function(){return o[o.length-1]};this.getPattern=function(){return s()},this.addNode=function(t){s().addNode(t)},this.addRelationship=function(t){s().addRelationship(t)},this.variable=function(t){r.addVariable(t,this.getLast())},this.getLast=function(t){return s().lastObject()},this.setPreviousOperation=function(t){e=t},this.setNextOperation=function(t){(n=t).setPreviousOperation(this)},this.previousOperation=function(){return e};var u=function(){n&&s().setNextAction(function(){i&&!i.evaluate()||n.doIt()})};this.doIt=function(){if(e.constructor==c)throw"WITH is required between MERGE and MATCH";u(),this.doIt=function(){for(var t in o)o[t].match()},this.doIt()},this.finish=function(){n&&n.finish()},this.run=function(t){for(var e in u(),o)o[e].match();n&&n.finish(),t(r.results())},this.type=function(){return this.constructor.name},this.variables=function(){return r.variables()}}function c(t){var e,n,i,r=t,o=[];this.where=function(t){i=new m(t)},this.addPattern=function(){o.push(new Le)};var s=function(){return o[o.length-1]};this.addNode=function(t){s().addNode(t)},this.addRelationship=function(t){s().addRelationship(t)},this.getLast=function(t){return s().lastObject()},this.variable=function(t){this.getLast().setVariableKey(t),r.addVariable(t,this.getLast())},this.setPreviousOperation=function(t){e=t},this.setNextOperation=function(t){(n=t).setPreviousOperation(this)},this.previousOperation=function(){return e};var u=function(){n&&s().setNextAction(function(){i&&!i.evaluate()||n.doIt()})};this.doIt=function(){u(),this.doIt=function(){s().merge()},this.doIt()},this.finish=function(){n&&n.finish()},this.run=function(t){u(),s().merge(),n&&n.finish(),t(r.results())},this.type=function(){return this.constructor.name},this.variables=function(){return r.variables()}}function R(n){n=n;var r,t=null,e=0,o=new u,s=function(t){return{value:t,map:{}}};this.getTrieRoot=function(){return t},this.beginMap=function(){null==t&&(t=s()),r=t},this.beginMap(),this.map=function(t){t.precalculate();var e,n=null==(e=t.groupByKey())||null==e?e:e.constructor==x||e.constructor==I?e.id():e.constructor==Array||e.constructor==Object?JSON.stringify(e):o.recode(e),i=t.groupByValue();r.map[n]||(r.map[n]=s(i)),r=r.map[n]},this.getReducer=function(t){return r.reducers||(r.reducers=new Array(e)),r.reducers[t]||(r.reducers[t]={}),r.reducers[t]},this.addReducer=function(){return e++},this.print=function(){i(t)};var i=function(t){var e;for(e in t.map)n.setNextMapValue(t.map[e].value),i(t.map[e]),n.moveToPreviousMapValue();e||(r=t,n.addAggregateOutputRecord())}}function N(t,e,n,i){var r,o=t,s=e,u=o.getAlias(),a=0,c=this,h=i;this.getAlias=function(){return u},this.setAlias=function(t){u=t,s.addVariable(u,this)},this.hasKey=function(){return o.hasKey()},this.setId=function(t){a=t},this.getId=function(){return a},this.value=function(){return null!=r?r:o.value()},this.groupByKey=function(){return this.value()},this.groupByValue=function(){return this.value()},this.get=function(){return c.value()},this.getData=function(){return c},this.getExpression=function(){return o},this.setGroupByValue=function(t){o.isArray()&&o.hasAggregateFunctions()||(r=t)},this.nextAction=function(){},this.setNextAction=function(t){this.nextAction=t},this.hidden=function(){return h},this.type=function(){return this.constructor.name}}function r(t){var e,c,n,i,r,o,s,h=t,f=[],u=0,a=!1,l=!1,d=this,p=0,g=0;this.where=function(t){o=new m(t)},this.limit=function(t){s=t},this.expression=function(t){w(t)},this.getLast=function(){return f[x()]},this.getGroupBy=function(){return null==e&&(e=new R(this)),e},this.hasGroupBy=function(){return null!=e},this.hasMapKeys=function(){return c&&0<c.length},this.doItCount=function(){return g};var v=function(){return null!=s&&p>=s.value()},y=function(){return!o||o.evaluate()};this.addReduceExpression=function(t){n||(n=[]),n.push(t)},this.setNextMapValue=function(t){c[u++].setGroupByValue(t)},this.moveToPreviousMapValue=function(){u--},this.addAggregateOutputRecord=function(){if(y()&&!(0==this.doItCount()&&this.hasMapKeys()||v())){for(var t=0;t<f.length;t++)f[t].nextAction();p++,r&&r.doIt()}},this.setReturnValueNextAction=function(t){t.setNextAction(function(){0==t.getId()&&h.addOutputRecord(),t.hidden()||h.addOutputEntry(t.getAlias(),t.value(),t.getId())})};var w=function(t,e){var n=!1;if(t.isArray())for(var i=t.root().element(),r=0;r<i.getElements().length;r++){var o=w(i.getElements()[r],!0);i.setElement(r,o),n=!0}else if(t.isAssociativeArray()){var s=t.root().element(),u=s.getValues();for(r=0;r<u.length;r++){o=w(u[r],!0);s.setValue(r,o),n=!0}}var a=new N(t,h,d,e);return f.push(a),f[x()].setId(x()),a.getExpression().isReduceExpression()||n||(c||(c=[]),c.push(a)),d.setReturnValueNextAction(a),l=t.hasReferredVariables(),a};this.setIsIntermediary=function(){a=!0},this.conveyorBeltEnd=function(){return!l&&a&&!n};var x=function(){return f.length-1};this.setPreviousOperation=function(t){i=t},this.setNextOperation=function(t){(r=t).setPreviousOperation(this)},this.previousOperation=function(){return i},this.nextOperation=function(){return r},this.variables=function(){if(!r&&i)return i.variables();for(var t=[],e=0;e<f.length;e++)f[e].hidden()||t.push(h.getVariable(f[e].getAlias()));return t},this.type=function(){return this.constructor.name};var b=function(){if(g++,d.hasGroupBy()){if(d.hasGroupBy()){if(e.beginMap(),c)for(t=0;t<c.length;t++)c[t].getExpression().aggregate();for(t=0;t<n.length;t++)n[t].aggregate()}}else{if(!y())return;if(v())return;for(var t=0;t<f.length;t++)f[t].nextAction();p++,r&&r.doIt()}};this.doIt=function(){this.conveyorBeltEnd()||b()},this.finish=function(){this.conveyorBeltEnd()&&b(),this.hasGroupBy()&&e.print(),r&&r.finish()},this.run=function(t){b(),r&&r.finish(),t(h.results())}}function o(t){var e=new r(t),n=this.constructor.name;return e.setReturnValueNextAction=function(t){t.hidden()||t.setNextAction(function(){e.hasGroupBy()&&_e.getVariable(t.getAlias()).setOverriddenValue(t.value())})},e.type=function(){return n},e.setIsIntermediary(),e}function s(t){var e,n,i,r,o,s=t,u=0;this.doIt=function(){if(n){if(!(r=i.value()))return;if(!r.length)throw"Unwind expects list expression.";for(u=0;u<r.length;u++)n.doIt()}},this.finish=function(){n&&n.finish()},this.run=function(t){this.doIt(),n&&n.finish(),t(s.results())},this.variable=function(t){o=t,s.addVariable(t,this)},this.variables=function(){return[s.getVariable(o)]},this.expression=function(t){i=t},this.setPreviousOperation=function(t){e=t},this.setNextOperation=function(t){(n=t).setPreviousOperation(this)},this.previousOperation=function(){return e},this.nextOperation=function(){return n},this.value=function(){return r[u]},this.get=function(){return this.value()},this.getData=function(){return this},this.type=function(){return this.constructor.name}}function h(t){var x,e,n=t,i=null,b=!1,r=",",o=null,m=null,s=null,u=n.engine().getDataDownloadProxy();this.csv=function(){i="CSV"},this.json=function(){i="JSON"},this.loadType=function(){return i},this.headers=function(){b=!0},this.setFieldTerminator=function(t){if(1<t.length||0==t.length)throw"Field terminator must be one char.";r=t},this.fieldTerminator=function(){return r},this.expression=function(t){o=t},this.getLast=function(){return o},this.variable=function(t){n.addVariable(t,this)},this.getProperty=function(t){return x[t]},this.from=function(){return u?u+o.value():o.value()},this.get=function(){return x},this.value=function(){return this.get()},this.groupByKey=function(){return x},this.groupByValue=function(){return this.get()},this.getData=function(){return this},this.statement=function(){return n},this.setPreviousOperation=function(t){e=t},this.setNextOperation=function(t){(s=t).setPreviousOperation(this)},this.previousOperation=function(){return e},this.variables=function(){return n.variables()};this.doIt=function(){this.run()},this.finish=function(){},this.run=function(e){var n=this;a.get(n.from(),function(t){"CSV"==n.loadType()?(m=t,function(t,e){for(var n=[],i=0,r={},o=0,s="",u=0,a=!1,c=t||",",h=function(){s=m.charAt(u++),d()&&(a=!a,h())},f=function(){return y()?"\0":m.charAt(u)},l=function(){return!(!p||'"'!=s||'"'!=f())},d=function(){return!l()&&'"'==s},p=function(){return a},g=function(){return s==c},v=function(){return"\r"==s&&"\n"==f()&&h(),"\n"==s},y=function(){return u>=m.length},w=function(){for(var t="";!(g()||v()||y())||p();)t+=l()?(s=m.charAt(++u),'""'):s,h();0==o&&(b?n.push(t):b||n.push(n.length)),(0<o&&b||!b)&&(r[n[i++]]=t),g()&&h()};!y();){for(;!v()&&!y();)w();0<o++&&(x=r,r={},i=0,e()),h()}}(n.fieldTerminator(),function(){s.doIt()})):"JSON"==n.loadType()&&function(t,e){if(t.constructor==Array)for(var n=0;n<t.length;n++)x=O(t[n]),e();else t.constructor==Object&&(x=O(t),e())}(JSON.parse(t),function(){s.doIt()}),s&&s.finish(),e&&e(n.statement().results())},function(t){throw n.type()+": "+t})},this.type=function(){return this.constructor.name}}var f=function(t){var e,n={};for(key in t){for(var i=t[key].displayValue(),r=n,o=0;o<i.length;o++)r[e=i.charAt(o).toUpperCase()]||(r[e]={}),r=r[e];r.isF=!0,r.f=t[key]}return n},l=function(t,e,n,i){for(var r=e,o=i,s=function(t){return n.charAt(t).toUpperCase()};;){if(!r[s(o)])return 0;if((r=r[s(o)]).isF&&!r[s(o+1)])return t.latestParsed=r.f,o-i+1;o++}};function ke(t,e){t=t;this.action=e,this.displayValue=function(){return t}}function Me(t,e,n,i){t=t,e=e,n=n;this.value=i,this.isOperator=!0,this.displayValue=function(){return t},this.precedence=function(){return e},this.leftAssociativity=function(){return n},this.rightAssociativity=function(){return!n}}function Se(t,e,n,i,r){var o=t,s=e,u=n,a=r;this.value=i,this.getObject=i,this.groupByKey=i,this.groupByValue=i,this.isFunction=!0,this.displayValue=function(){return o},this.parametric=function(){return 0<s},this.precedence=function(){return 12},this.leftAssociativity=function(){return!0},this.rightAssociativity=function(){return!this.leftAssociativity},this.verifyParsedParameterCount=function(t){if(t<s)throw'Too few parameters for function "'+o+'".';if(u<t)throw'Too many parameters for function "'+o+'".'},this.returnType=function(){return a}}function Ke(t,e,n,i,r,o,s){var u,a,c=t,h=0,f=e,l=n,d=s;this.initialize=i,this.value=r,this.getObject=r,this.aggregate=o,this.isFunction=!0,this.initializeIfNecessary=function(){this.initialize()},this.setReducer=function(t){a=t},this.setGroupBy=function(t){u=t},this.getGroupBy=function(){return u},this.getReducerId=function(){return a},this.displayValue=function(){return c},this.precedence=function(){return 12},this.leftAssociativity=function(){return!0},this.rightAssociativity=function(){return!this.leftAssociativity},this.parametric=function(){return 0<f},this.parsedParameterCount=function(){return h},this.verifyParsedParameterCount=function(t){if((h=t)<f)throw'Too few parameters for function "'+c+'".';if(l<h)throw'Too many parameters for function "'+c+'".'},this.returnType=function(){return d}}function p(t){for(var e=t;e;)console.log(e),e=e.caller}function Ge(i){return i.contains=function(t){for(var e=0;e<i.length;e++)if(t==i[e])return!0;return!1},i.toLowerCase=function(){for(var t=[],e=0;e<i.length;e++)t.push(i[e].toLowerCase&&i[e].toLowerCase()||i[e]);return t},i.toUpperCase=function(){for(var t=[],e=0;e<i.length;e++)t.push(i[e].toUpperCase&&i[e].toUpperCase()||i[e]);return t},i.get=function(){return i},i.last=function(){return i[i.length-1]},i.beforeLast=function(){return i[i.length-2]},i.value=function(){return i},i.join=function(t){for(var e="",n=0;n<i.length;n++)e+=(0<n?t:"")+i[n];return e},i.trim=function(){for(var t=new Array(i.length),e=0;e<i.length;e++)t[e]=i[e].trim();return t},i}function O(e){return e.getProperty=function(t){return e[t]},e.getProperties=function(){return e},e.getKeys=function(){var t=[];for(key in e)e[key].constructor!==Function&&t.push(key);return t},e}function x(t,e){var n=t,i=e;this.nodeId=function(){return i},this.id=this.nodeId,this.getNode=function(){return n.getNodeById(i)},this.getObject=function(){return n.getNodeById(i)},this.value=function(){return n.getNodeById(i).toObject()},this.getData=this.value,this.getProperty=function(t){return n.getNodeById(i).getLocalProperty(t)},this.getProperties=function(){return this.value().getProperties()},this.getKeys=function(){return this.value().getProperties().getKeys()},this.groupByKey=this.nodeId}function I(t,e){var n=t,i=e;this.relationshipId=function(){return i},this.id=this.relationshipId,this.getRelationship=function(){return n.getRelationshipById(i)},this.getObject=function(){return n.getRelationshipById(i)},this.value=function(){return n.getRelationshipById(i).toObject()},this.getData=this.value,this.getProperty=function(t){return n.getRelationshipById(i).getLocalProperty(t)},this.getProperties=function(){return this.value().getProperties()},this.getKeys=function(){return this.value().getProperties().getKeys()},this.getType=function(){return this.value().getType()},this.groupByKey=this.relationshipId}(ke.f={}).MATCH=new ke("MATCH",function(t){t.match()}),ke.f.MERGE=new ke("MERGE",function(t){t.merge()}),ke.f.WITH=new ke("WITH",function(t){t._with()}),ke.f.RETURN=new ke("RETURN",function(t){t._return()}),ke.f.LIMIT=new ke("LIMIT",function(t){}),ke.f.UNWIND=new ke("UNWIND",function(t){t.unwind()}),ke.f.WHERE=new ke("WHERE",function(t){}),ke.f.LOAD=new ke("LOAD",function(t){t.load()}),ke.f.CSV=new ke("CSV",function(t){t.csv()}),ke.f.JSON=new ke("JSON",function(t){t.json()}),ke.f.HEADERS=new ke("HEADERS",function(t){t.headers()}),ke.f.FROM=new ke("FROM",function(t){}),ke.f.AS=new ke("AS",function(t){}),ke.f.FIELDTERMINATOR=new ke("FIELDTERMINATOR",function(t){}),ke.f.SET=new ke("SET",function(t){}),ke.f.DISTINCT=new ke("DISTINCT",function(t){}),ke.f.TRUE=new ke("TRUE",function(t){}),ke.f.FALSE=new ke("FALSE",function(t){}),ke.f.NULL=new ke("NULL",function(t){}),ke.f.CASE=new ke("CASE",function(t){}),ke.f.WHEN=new ke("WHEN",function(t){}),ke.f.THEN=new ke("THEN",function(t){}),ke.f.ELSE=new ke("ELSE",function(t){}),ke.f.END=new ke("END",function(t){}),ke.trie=f(ke.f),ke.isKeyWord=function(t,e){return l(ke,ke.trie,t,e)},(Me.f={}).POWER=new Me("^",11,!1,function(){return Math.pow(this.lhs.value(),this.rhs.value())}),Me.f.MULTIPLY=new Me("*",10,!0,function(){return this.lhs.value()*this.rhs.value()}),Me.f.DIVIDE=new Me("/",10,!0,function(){return this.lhs.value()/this.rhs.value()}),Me.f.MODULO=new Me("%",10,!0,function(){return this.lhs.value()%this.rhs.value()}),Me.f.PLUS=new Me("+",9,!0,function(){return this.lhs.value().constructor==Array?this.lhs.value().concat(this.rhs.value()):this.rhs.value().constructor==Array?[this.lhs.value()].concat(this.rhs.value()):this.lhs.value()+this.rhs.value()}),Me.f.MINUS=new Me("-",9,!0,function(){return this.lhs.value()-this.rhs.value()}),Me.f.GREATER_THAN=new Me(">",8,!0,function(){return this.lhs.value()>this.rhs.value()}),Me.f.LESS_THAN=new Me("<",8,!0,function(){return this.lhs.value()<this.rhs.value()}),Me.f.GREATER_THAN_OR_EQUALS=new Me(">=",8,!0,function(){return this.lhs.value()>=this.rhs.value()}),Me.f.LESS_THAN_OR_EQUALS=new Me("<=",8,!0,function(){return this.lhs.value()<=this.rhs.value()}),Me.f.EQUALS=new Me("=",7,!0,function(){return this.lhs.value()==this.rhs.value()}),Me.f.NOT_EQUALS=new Me("<>",7,!0,function(){return this.lhs.value()!=this.rhs.value()}),Me.f.IN=new Me("IN",7,!0,function(){return!this.rhs.element().value().contains&&function(){throw"Not a list expression."}(),this.rhs.element().value().contains(this.lhs.value())}),Me.f.IS=new Me("IS",7,!0,function(){return this.lhs.value()==this.rhs.value()}),Me.f.AND=new Me("AND",6,!0,function(){return this.lhs.value()&&this.rhs.value()}),Me.f.OR=new Me("OR",5,!0,function(){return this.lhs.value()||this.rhs.value()}),Me.f.NONE=new Me("NONE",-1,!0,null),Me.trie=f(Me.f),Me.latestParsed=null,Me.isOperator=function(t,e){return l(Me,Me.trie,t,e)},(Se.f={}).PI=new Se("PI",0,0,function(){return Math.PI}),Se.f.E=new Se("E",0,function(){return Math.E}),Se.f.sqrt=new Se("sqrt",1,1,function(){return Math.sqrt(this.p[0].value())}),Se.f.log=new Se("log",2,2,function(){return Math.log(this.p[0].value())/(this.p[1].value()?Math.log(this.p[1].value()):1)}),Se.f.ln=new Se("ln",1,1,function(){return Math.log(this.p[0].value())}),Se.f.sin=new Se("sin",1,1,function(){return Math.sin(this.p[0].value())}),Se.f.cos=new Se("cos",1,1,function(){return Math.cos(this.p[0].value())}),Se.f.id=new Se("id",1,1,function(){return this.p[0].value().id()}),Se.f.labels=new Se("labels",1,1,function(){return this.p[0].value().labels()}),Se.f.type=new Se("type",1,1,function(){return this.p[0].value().getType()}),Se.f.properties=new Se("properties",1,1,function(){return this.p[0].value().getProperties()}),Se.f.exists=new Se("exists",1,1,function(){return null!=this.p[0].value()}),Se.f.keys=new Se("keys",1,1,function(){return this.p[0].value().getKeys()}),Se.f.nodes=new Se("nodes",1,1,function(){return this.p[0].value().getNodes()}),Se.f.relationships=new Se("relationships",1,1,function(){return this.p[0].value().getRelationships()}),Se.f.head=new Se("head",1,1,function(){return this.p[0].value().shift?this.p[0].value().shift():null}),Se.f.last=new Se("last",1,1,function(){return 0<this.p[0].value().length?this.p[0].value()[this.p[0].value().length-1]:null}),Se.f.size=new Se("size",1,1,function(){return this.p[0].value().length}),Se.f.object_lookup=new Se("object_lookup",2,2,function(){if(this.p[0].value().getProperty)return this.p[0].value().getProperty(this.p[1].value());try{return this.p[0].value()[this.p[1].value()]}catch(t){}return null}),Se.f.array_lookup=new Se("array_lookup",2,2,function(){try{return this.p[0].value()[this.p[1].value()]}catch(t){}return null}),Se.f.split=new Se("split",2,2,function(){return Ge(this.p[0].value().split(this.p[1].value()))},Te),Se.f.join=new Se("join",1,2,function(){var t=null!=this.p[1]&&this.p[1].value()||",";return this.p[0].value().join(t)}),Se.f.trim=new Se("trim",1,1,function(){return this.p[0].value().trim()}),Se.f.range=new Se("range",2,3,function(){var t=parseInt(this.p[0].value()),e=parseInt(this.p[1].value()),n=null!=this.p[2]&&parseInt(this.p[2].value())||1;if(0==n)throw"Zero step-size not allowed";if(n<0&&0<e&&t<e)throw"Negative step-size and positive end of range not allowed.";if(0<n&&e<0)throw"Positive step-size and negative end of range not allowed.";if(e<t&&0<n)throw"End of range smaller than start of range and positive step-size not allowed.";for(var i=[],r=t;r!=e;r+=n)i.push(r);return Ge(i)},Te),Se.f.lower=new Se("lower",1,1,function(){return this.p[0].value().toLowerCase()}),Se.f.upper=new Se("upper",1,1,function(){return this.p[0].value().toUpperCase()}),Se.f.toint=new Se("toint",1,1,function(){return parseInt(this.p[0].value())}),Se.f.tofloat=new Se("tofloat",1,1,function(){return parseFloat(this.p[0].value())}),Se.f.tostring=new Se("tostring",1,1,function(){try{return this.p[0].value().toString()}catch(t){}return this.p[0].value()+""}),Se.f.todate=new Se("todate",1,1,function(){return new Date(this.p[0].value())}),Se.f.coalesce=new Se("coalesce",2,2,function(){return null==this.p[0].value()?this.p[1].value():this.p[0].value()}),Se.f.round=new Se("round",1,1,function(){return Math.round(this.p[0].value())}),Se.f.rand=new Se("rand",0,0,function(){return Math.random()}),Se.f.timestamp=new Se("timestamp",0,0,function(){return new Date}),Se.f.not=new Se("not",1,1,function(){return!this.p[0].value()}),Se.trie=f(Se.f),Se.latestParsed=null,Se.isFunction=function(t,e){return l(Se,Se.trie,t,e)},(Ke.f={}).sum=new Ke("sum",1,1,function(){this.getGroupBy().getReducer(this.getReducerId()).result||(this.getGroupBy().getReducer(this.getReducerId()).result=0)},function(){return this.getGroupBy().getReducer(this.getReducerId()).result||new Number(0)},function(){this.initializeIfNecessary(),this.getGroupBy().getReducer(this.getReducerId()).result+=this.p[0].value()}),Ke.f.count=new Ke("count",1,1,function(){this.getGroupBy().getReducer(this.getReducerId()).result||(this.distinct()?this.distinct()&&(this.getGroupBy().getReducer(this.getReducerId()).result={}):this.getGroupBy().getReducer(this.getReducerId()).result=0)},function(){return this.distinct()?this.distinct()?Object.keys(this.getGroupBy().getReducer(this.getReducerId()).result).length:void 0:this.getGroupBy().getReducer(this.getReducerId()).result||new Number(0)},function(){if(this.initializeIfNecessary(),this.distinct()){if(this.distinct()){var t=this.p[0].value().groupByKey&&this.p[0].value().groupByKey()||this.p[0].value();null==this.getGroupBy().getReducer(this.getReducerId()).result[t]&&(this.getGroupBy().getReducer(this.getReducerId()).result[t]=!0)}}else this.getGroupBy().getReducer(this.getReducerId()).result+=1}),Ke.f.stdev=new Ke("stdev",1,1,function(){this.getGroupBy().getReducer(this.getReducerId()).result||(this.getGroupBy().getReducer(this.getReducerId()).result=[])},function(){for(var t,e=0,n=this.getGroupBy().getReducer(this.getReducerId()).result,i=0;i<n.length;i++)e+=n[i];t=e/n.length;for(i=e=0;i<n.length;i++)e+=Math.pow(n[i]-t,2);return Math.sqrt(e/(n.length-1))},function(){this.initializeIfNecessary(),this.getGroupBy().getReducer(this.getReducerId()).result.push(this.p[0].value())}),Ke.f.collect=new Ke("collect",1,1,function(){this.getGroupBy().getReducer(this.getReducerId()).result||(this.distinct()?this.distinct()&&(this.getGroupBy().getReducer(this.getReducerId()).result={}):this.getGroupBy().getReducer(this.getReducerId()).result=Ge([]))},function(){return this.distinct()?this.distinct()?Object.values(this.getGroupBy().getReducer(this.getReducerId()).result):void 0:this.getGroupBy().getReducer(this.getReducerId()).result||Ge([])},function(){if(this.initializeIfNecessary(),this.distinct()){if(this.distinct()){var t=this.p[0].value().groupByKey&&this.p[0].value().groupByKey()||this.p[0].value();null==this.getGroupBy().getReducer(this.getReducerId()).result[t]&&(this.getGroupBy().getReducer(this.getReducerId()).result[t]=this.p[0].value())}}else this.getGroupBy().getReducer(this.getReducerId()).result.push(this.p[0].value())},Te),Ke.trie=f(Ke.f),Ke.latestParsed=null,Ke.isAggregateFunction=function(t,e){return l(Ke,Ke.trie,t,e)};var g,Fe=new e(this),_e=new function(t){var n,e,i=t,r=[],o={},s=[],u={nodes:{},relationships:{}},a=0,c=0,h=[],f=void 0;this.addOperation=function(t){if(this.context()&&"Return"==this.context().type())throw"There can only be one return statement and it must be last in the query.";this.context()&&this.context().setNextOperation(t),r.push(t)},this.operations=function(){return r},this.context=function(){return f||r[r.length-1]},this.setContext=function(t){f&&h.push(f),f=t},this.resetContext=function(){f=h.pop()},this.addVariable=function(t,e){if(n=new d(e,t),o[t])throw"Variable `"+t+"` already declared.";o[t]=n},this.debugVariables=function(){for(var t in o)console.log('Variable "'+t+'":'),console.log(JSON.stringify(o[t].value()))},this.variables=function(){return Object.values(o)},this.getVariable=function(t){if(!o[t])throw"Variable `"+t+"` has not been declared.";return o[t]},this.hasVariable=function(t){return null!=o[t]},this.getLastVariable=function(){return n},this.setPropertyKey=function(t){e=t},this.getPropertyKey=function(){return e},this.clear=function(){r=[],o={},variableList=[],e=n=void 0,s=[],c=a=0,u={nodes:{},relationships:{}}},this.engine=function(){return i},this.results=function(){return l(),{output:s,graph:{nodes:Object.values(u.nodes),links:Object.values(u.relationships)},stats:{nodesAdded:a,relationshipsAdded:c}}},this.addOutputRecord=function(){s.push({})},this.addOutputEntry=function(t,e,n){var i=t;null!=s[s.length-1][i]&&(i+=n),this.addOutputEntryToGraph(e),s[s.length-1][i]=function t(e){if(e&&e.constructor==String)return e.replace(/\0/g,"");if(e&&(e.constructor==x||e.constructor==I))return t(e.value());if(e){for(var n in e)"function"!=typeof e[n]?e[n]&&(e[n]=t(e[n])):delete e[n];e.fromNode&&(e.fromNode=t(e.fromNode)),e.toNode&&(e.toNode=t(e.toNode))}return e}(e)};var l=function(){var t,e=[];for(var n in u.relationships)t=u.relationships[n],u.nodes[t.source]&&u.nodes[t.target]||e.push(n);for(var i=0;i<e.length;i++)delete u.relationships[e[i]]};this.addOutputEntryToGraph=function(t){if(t&&t.constructor==x)u.nodes[t.id()]||(u.nodes[t.id()]=t.value());else if(t&&t.constructor==I){if(!u.relationships[t.id()]){var e=t.getObject().toObject();e.source=e.fromNode.id(),e.target=e.toNode.id(),u.relationships[t.id()]=e}}else if(t&&t.constructor==Array)for(var n=0;n<t.length;n++)this.addOutputEntryToGraph(t[n])},this.setNodesAdded=function(t){a=t},this.setRelationshipsAdded=function(t){c=t},this.getNodesAdded=function(){return a},this.getRelationshipsAdded=function(){return c}}(this),He=new function(t){var i,a=t,e=void 0,o=0,n="",r=!1,s="(): {}\"',.\n+-/*^[]=<>!",u={},c=!1,h=0;!function(){for(var t=0;t<s.length;t++)u[s[t]]=!0}(),this.parse=function(t){i=t,n="",c=!1,h=o=0,f()};var f=function(){if((d()||E()||P()||g()||v()||l())&&f(),ee())throw Ie("Expected keyword.")},l=function(){return Ee(),!!Lt()&&(B(),a.expression(),J(),I(),!0)},d=function(){if(Ee(),Bt()){if(Ee(),Vt()){if(Ee(),Pt(!0)&&(Ee(),!Dt()))throw Ie("Expected HEADERS-keyword.");if(Ee(),!jt())throw Ie("Expected FROM-keyword.");if(B(),a.expression(),!z())throw Ie("Expected alias.");p()}else{if(!Tt())throw Ie("Expected CSV- or JSON-keyword.");if(Ee(),!jt())throw Ie("Expected FROM-keyword.");if(B(),a.expression(),!z())throw Ie("Expected alias.")}return!0}return!1},p=function(){if(Ee(),kt()){if(Ee(),!U())throw Ie("Expected single- or doublequoted string.");a.statement().context().setFieldTerminator(te())}},g=function(){return Ee(),!(!Pt()||!y(!0)||(I(),0))},v=function(){return Ee(),!!Ot()&&y()},y=function(t){do{if(Ee(),ce())ct();else if(B(),a.expression(),!q()&&t&&!a.lastObject().hasKey())throw Ie("Expression in WITH must be aliased (use AS).")}while(ve());return O(),Ee(),A(),!0},w=function(t){if(we()){if(t&&a.pattern(),a.node(),S(!0)){var e=te(),n=K(),i=F();if(n||i){if(a.variableExists(e))throw"It is not allowed to create a new node in this context.";a.variable(e)}else if(a.variableExists(e)){var r=a.getVariable(e).getObject();if(!r.isNode())throw"Variable `"+e+"` is bound to a "+r.type()+".";a.lastObject().setReferredNode(r)}else a.variable(e)}else K(),F();if(!xe())throw Ie("Expecting closing parentheses.");return!0}return!1},x=function(){if(ce()){if("Merge"==a.operation()||"Create"==a.operation())throw"Variable path length not supported in this context.";if(a.context().setHasVariablePathLength(),Xt()&&a.context().setPathLengthFrom(parseInt(te())),he()){if(!he())throw Ie('Expected "."');Xt()&&a.context().setPathLengthTo(parseInt(te()))}return!0}return!1},b=function(){var t=ie();if(oe()){if(a.relationship(),t&&a.leftDirection(),Re()){if(S(!0)){var e=te(),n=G(),i=F(),r=x();if(n||i||r){if(a.variableExists(e))throw"It is not allowed to create a new relationship in this context.";a.variable(e)}else if(a.variableExists(e)){var o=a.getVariable(e).getObject();if(!o.isRelationship())throw"Variable `"+e+"` is bound to a "+o.type()+".";a.lastObject().setReferredRelationship(o)}else a.variable(e)}else G(),F(),x();if(!Ne())throw Ie("Expected closing square bracket.");if(!oe())throw Ie("Expected relationship line.");return re()&&a.rightDirection(),!0}throw Ie("Expected opening square bracket.")}return!1},m=function(t){var e,n=t;if(Zt(),we()){if(S(!0)){var i=te();if(he()||Re()||zt()||we())return $t(),!1;if(!a.variableExists(i))throw'Variable "'+i+'" does not exist.';if((e=a.getVariable(i).getObject()).constructor!=Ae)return $t(),!1}if(n||(n=ft(new Le),_e.setContext(n.element())),n.element().addNode(new Ae(Fe)),e&&n.element().lastObject().setReferredNode(e),K(),F(),!xe())throw Ie("Expecting closing parentheses.");return n}return!1},R=function(t){var e=ie();if(oe()){if(t.element().addRelationship(new Be(Fe)),e&&t.element().leftDirection(),Re()){var n;if(S(!0)){var i=te();if(!a.variableExists(i))throw'Variable "'+i+'" does not exist.';if(!(n=a.getVariable(i).getObject()).isRelationship())throw"Variable `"+i+"` is bound to a "+n.type()+".";t.element().lastObject().setReferredRelationship(a.getVariable(i).getObject())}if(G(),F(),x()&&n)throw"Path expansion not allowed for referred relationship.";if(!Ne())throw Ie("Expected closing square bracket.");if(!oe())throw Ie("Expected relationship line.");return re()&&a.rightDirection(),!0}throw Ie("Expected opening square bracket.")}return!1},N=function(t){var e=void 0;if(S(!0)){if(Ee(),t&&ge())throw Ie("Path variable not allowed in this context.");if(e=te(),!ge())throw Ie("Expected variable assignment.");Ee()}if(w(!0)){for(e&&_e.addVariable(e,_e.context().getLast().getPattern());b();)if(!w())throw Ie("Expecting node pattern.");return!0}return!1},E=function(){if(Ee(),Rt()){if(Ee(),!N())throw Ie("Expecting graph pattern.");return O(),I(),!0}return!1},P=function(){if(Ee(),mt()){do{if(Ee(),!N())throw Ie("Expecting graph pattern.")}while(ve());return O(),I(),!0}return!1},O=function(){At()&&(B(),a.where(He.getExpression()))},I=function(){if(Ee(),Mt()){a.setter();do{if(!S(!0))throw Ie("Expected variable.");var t=a.getVariable(te());if(he()){var e;if(!H())throw Ie("Expected property key.");if(e=te(),Ee(),!ge())throw Ie("Expected equals character (=).");Ee(),B();var n=He.getExpression();a.operationContext().addSetter(t,e,n)}else if(K(),t.getObject().constructor!=Ae)throw"Can't assign a label to a \""+t.getObject().getType()+'".'}while(ve())}},A=function(){It()&&(B(!0),a.limit(He.getExpression()))},B=function(t){var e,n,i,r=!0;if(n=function(){if(Zt(),S(!0)){if(Ee(),ge())throw Ie("Path variable not allowed in this context.");$t()}if(!we())return!1;o--;var e=!1;try{var t=m();if(t){for(;R(t);)if(!m(t))throw Ie("Expecting node pattern.");return t.element().useAsCondition(),_e.resetContext(),t}}catch(t){throw e=!0,_e.resetContext(),t}return e||_e.resetContext(),!1}())r=!1;else if(we()){if(xt(),n=B(t),!xe())throw Ie("Expected closing parentheses.");bt()}else if(Nt())n=k();else if(Et())n=C();else if(W())n=at(te());else if(e=T())gt(e),r=!1;else if(S(!0)){if(t)throw Ie("Variables not allowed within this context.");n=ht(te())}else if(e=j())n=dt(e);else if(e=D())n=pt(e);else{if(i=c,c=!1,!i)throw Ie("Expected expression");if(notRequired)return!1}return n&&r&&L(n),Ee(),zt()&&(wt(Me.latestParsed),Ee(),B()),n},L=function(t){for(;;)if(he()){if(!H())throw Ie("Expected property key.");ot(t,te())}else if(!V(t)){ut();break}},V=function(t){if(Re()){He.addLayer(),B();var e=He.getExpression();if(He.finishLayer(),st(t,e),!Ne())throw Ie("Expected closing square bracket.");return!0}return!1},T=function(){if(_t()){Ee();for(var t=new De;Ht();){if(He.addLayer(),B(),t.when(He.getExpression()),He.finishLayer(),Ee(),!Ut())throw Ie("Expected THEN keyword");He.addLayer(),B(),t.then(He.getExpression()),He.finishLayer(),Ee()}if(0==t.whenCount())throw Ie("Expected WHEN keyword");if(Ee(),Wt()&&(He.addLayer(),B(),t.else(He.getExpression()),He.finishLayer()),Ee(),!qt())throw Ie("Expected WHEN keyword");return t}return!1},D=function(){if(be()){var t=new Ve;do{var e;if(!H())return!1;if(e=te(),!pe())throw Ie("Expected colon.");He.addLayer(),B(),t.addEntry(e,He.getExpression()),He.finishLayer()}while(ve());if(!me())throw Ie("Expected closing curly bracket.");return t}return!1},j=function(){if(Re()){for(var t=new Te;He.addLayer(),c=!0,B(),t.add(He.getExpression()),He.finishLayer(),ve(););if(!Ne())throw Ie("Expected closing bracket.");return t}return!1},C=function(){if(0<h)throw Ie("Not allowed to nest aggregation functions.");if(we()){var t=yt(Ke.latestParsed);if(xt(),h++,Ee(),St()&&t.setDistinct(),Ee(),Ke.latestParsed.parametric()){for(var e=0;M(),e++,ve(););try{t.verifyParsedParameterCount(e)}catch(t){throw Ie(t)}}if(!xe())throw Ie("Expected closing parentheses.");return bt(),h--,t}throw Ie("Expected opening parentheses.")},k=function(){if(we()){var t=vt(Se.latestParsed);if(xt(),Se.latestParsed.parametric()){for(var e=0;M(),e++,ve(););try{t.verifyParsedParameterCount(e)}catch(t){throw Ie(t)}}if(!xe())throw Ie("Expected closing parentheses.");return bt(),t}throw Ie("Expected opening parentheses.")},M=function(){He.addLayer(),B();var t=He.getExpression();He.finishLayer(),lt(t)},S=function(t){var e=!t;if(Ee(),ue(Oe()))return!1;if(de())for(;ee()&&!de();)n+=Oe(),o++;else if(!de())for(;ee()&&!u[Oe()];)n+=Oe(),o++;return 0<n.length&&(e&&a.variable(te()),!0)},K=function(){if(Ee(),!pe())return!1;var t="";if(de())for(;ee()&&!de();)t+=Oe(),o++;else if(!de())for(;ee()&&!u[Oe()];)t+=Oe(),o++;if(""==t)throw Ie("Expecting label name.");return a.label(t),K(),!0},G=function(){if(Ee(),!pe())return!1;var t="";if(de())for(;ee()&&!de();)t+=Oe(),o++;else if(!de())for(;ee()&&!u[Oe()];)t+=Oe(),o++;if(""==t)throw Ie("Expecting type name.");return a.type(t),!0},F=function(){if(Ee(),be()){if(!_())throw Ie("Expecting at least one property.");if(!me())throw Ie("Expecting closing curly brackets.");return!0}return!1},_=function(){if(!H())return!1;if(a.propertyKey(te()),!pe())throw Ie("Expected colon.");return He.addLayer(),B(),a.propertyValue(),He.finishLayer(),!ve()||_()},H=function(){if(Ee(),ue(Oe()))return!1;if(de())for(;ee()&&!de();)n+=Oe(),o++;else if(!de())for(;ee()&&!u[Oe()];)n+=Oe(),o++;return 0!=n.length},U=function(){if(fe()){for(r=!0;ee()&&!fe();)ye(),n+=Oe(),o++;r=!1}else{if(!le())return!1;for(r=!0;ee()&&!le();)ye(),n+=Oe(),o++;r=!1}return!0},W=function(){if(U());else if(Qt())n=parseFloat(n);else if(Kt())n=!0;else if(Gt())n=!1;else{if(!Ft())return!1;n=null}return!0},q=function(){if(Ee(),Ct()){if(!S(!0))throw Ie("Expected alias variable key.");return a.as(te()),!0}return!1},z=function(){if(Ee(),Ct()){if(!S(!1))throw Ie("Expected alias variable key.");return a.as(te()),!0}return!1},J=function(){if(Ee(),Ct()){if(!S(!1))throw Ie("Unwinded collection must be aliased.");return!0}return!1};function Q(t,e){var n=t,i=e;this.getObject=function(){return n.statement().getVariable(i).getObject()},this.value=function(t){return n.statement().getVariable(i).value(t)},this.getKey=function(){return i},this.type=function(){return n.statement().getVariable(i).getObject().type()},this.groupByKey=function(){var t=n.statement().getVariable(i).getObject();return t.groupByKey&&t.groupByKey()||t},this.groupByValue=function(){var t=n.statement().getVariable(i).getObject();return t.groupByValue&&t.groupByValue()||t}}function X(t){var e=t,n=0,i=void 0,r=void 0,o=this,s=this,u=0;this.element=function(){return e},this.precalculate=function(){n=0,i=this.value(),r=this.value,c(a)};var a=function(){if(i&&0==n)return n++,i;if(i&&1==n){var t=i;return i=void 0,n=0,c(r),t}},c=function(t){o.value=t,o.groupByKey=o.value,o.groupByValue=o.value};this.elementValueContext=function(){return s},this.elementValue=function(){return e.value.call(s)},this.type=e.type,this.value=this.elementValue,this.groupByKey=e.groupByKey||this.elementValue,this.groupByValue=e.groupByValue||this.elementValue,this.hasKey=function(){return e.getKey&&e.getKey()},this.parsedParameterCount=function(){return u},this.verifyParsedParameterCount=function(t){e.constructor!=Se&&e.constructor!=Ke||(u=t,e.verifyParsedParameterCount(u))}}function Y(t){X.call(this,t);var e=!1;this.setReducer=function(t){this.element().setReducer.call(this.elementValueContext(),t)},this.setGroupBy=function(t){this.element().setGroupBy.call(this.elementValueContext(),t)},this.getGroupBy=function(){return this.element().getGroupBy.call(this.elementValueContext())},this.getReducerId=function(){return this.element().getReducerId.call(this.elementValueContext())},this.initializeIfNecessary=function(){this.initialize()},this.initialize=function(){return this.element().initialize.call(this.elementValueContext())},this.aggregate=function(){return this.element().aggregate.call(this.elementValueContext())},this.value=function(){return this.element().value.call(this.elementValueContext())},this.groupByKey=function(){return this.element().groupByKey.call(this.elementValueContext())},this.groupByValue=function(){return this.element().groupByValue.call(this.elementValueContext())},this.hasKey=function(){return this.element().getKey&&this.element().getKey()},this.distinct=function(){return e},this.setDistinct=function(){e=!0}}(Y.prototype=Object.create(X.prototype)).constructor=Y;var Z=[],$=[],tt=[],et=function(){$=[],tt=[]},nt=function(){return 0==tt.length?null:tt[tt.length-1]};this.addLayer=function(){Z.push({output:$,operators:tt}),et()},this.finishLayer=function(){var t=Z.pop();$=t.output,tt=t.operators};var it=function(t){return $.push(t),0==$.length?null:$[$.length-1]},rt=function(t){return tt.push(t),nt()},ot=function(t,e){t.lookups||(t.lookups=[]),t.lookups.push({function:Se.f.object_lookup,index:new X(new je(e))})},st=function(t,e){t.lookups||(t.lookups=[]),t.lookups.push({function:Se.f.array_lookup,index:new X(e)})},ut=function(){},at=function(t){return it({isAtom:!0,v:new X(new je(t))}).v},ct=function(){for(var t=a.statement().context().variables(),e=0;e<t.length;e++)ht(t[e].getObjectKey()),a.expression()},ht=function(t){return it({isAtom:!0,isVariable:!0,v:new X(new Q(a,t))}).v},ft=function(t){return it({isAtom:!0,v:new X(t)}).v},lt=function(t){return it({isAtom:!0,v:new X(t)}).v},dt=function(t){return it({isAtom:!0,v:new X(t)}).v},pt=function(t){return it({isAtom:!0,v:new X(t)}).v},gt=function(t){return it({isAtom:!0,v:new X(t)}).v},vt=function(t){return rt({isFunction:!0,v:new X(t)}).v},yt=function(t){return rt({isAggregateFunction:!0,isFunction:!0,v:new Y(t)}).v},wt=function(t){for(;0<tt.length&&(tt.slice(-1)[0].isOperator||tt.slice(-1)[0].isFunction)&&(e=t,n=tt.slice(-1)[0].v.element(),e.leftAssociativity()&&e.precedence()<=n.precedence()||e.rightAssociativity()&&e.precedence()<n.precedence());)$.push(tt.pop());var e,n;return rt({isOperator:!0,v:new X(t)}).v},xt=function(){rt({leftParentheses:!0})},bt=function(){for(;0<tt.length&&!tt.slice(-1)[0].leftParentheses;)$.push(tt.pop());tt.pop()};this.getExpression=function(){return function(){for(;0<tt.length;)$.push(tt.pop());for(var t,e,n=Ge([]),i=[];0<$.length;){if((e=$.shift()).isOperator)e.v.rhs=n.pop().v,e.v.lhs=n.pop().v;else if(e.isFunction){e.v.p=[];for(var r=0;r<e.v.parsedParameterCount();r++)e.v.p.unshift(n.pop().v);e.isAggregateFunction&&(t||(t=[]),e.v.p=e.v.p,t.push(e.v))}if(e.isVariable&&i.push(e.v.element().getKey()),e.v.lookups)for(var o,s,u=e.v.lookups;u&&0<u.length;)s=e.v,o=u.shift(),e.v=new X(o.function),e.v.p=[s,o.index];n.push(e)}return et(),0==n.length?null:new Ce(n.pop().v,"expr",t,a.statement().context(),i)}()};var mt=function(){return Jt(ke.f.MATCH)},Rt=function(){return Jt(ke.f.MERGE)},Nt=function(){var t;return 0<(t=Se.isFunction(i,o))&&(o+=t,!!we(!0,!0)||(o-=t,!1))},Et=function(){var t;return 0<(t=Ke.isAggregateFunction(i,o))&&(o+=t,!0)},Pt=function(t){return Jt(ke.f.WITH,t)},Ot=function(){return Jt(ke.f.RETURN)},It=function(){return Jt(ke.f.LIMIT)},At=(Ot=function(){return Jt(ke.f.RETURN)},function(){return Jt(ke.f.WHERE)}),Bt=function(){return Jt(ke.f.LOAD)},Lt=function(){return Jt(ke.f.UNWIND)},Vt=function(){return Jt(ke.f.CSV)},Tt=function(){return Jt(ke.f.JSON)},Dt=function(){return Jt(ke.f.HEADERS)},jt=function(){return Jt(ke.f.FROM)},Ct=function(){return Jt(ke.f.AS)},kt=function(){return Jt(ke.f.FIELDTERMINATOR)},Mt=function(){return Jt(ke.f.SET)},St=function(){return Jt(ke.f.DISTINCT)},Kt=function(){return Jt(ke.f.TRUE)},Gt=function(){return Jt(ke.f.FALSE)},Ft=function(){return Jt(ke.f.NULL)},_t=function(){return Jt(ke.f.CASE)},Ht=function(){return Jt(ke.f.WHEN)},Ut=function(){return Jt(ke.f.THEN)},Wt=function(){return Jt(ke.f.ELSE)},qt=function(){return Jt(ke.f.END)},zt=function(){var t;return 0<(t=Me.isOperator(i,o))&&(o+=t,!0)},Jt=function(t,e){var n;return 0<(n=ke.isKeyWord(i,o))&&ke.latestParsed===t&&(e||ke.latestParsed.action(a),o+=n,!0)},Qt=function(){Ee();var t=!1;if(se()&&(Yt(),t=!0),!ae()){if(t)throw Ie("Expected number.");return!1}for(Yt();ae();)Yt();if(he()){if(Yt(),!ae())throw Ie("Expected one or more integers after decimal point.");for(Yt();ae();)Yt()}return Ee(),!0},Xt=function(){if(Ee(),!ae())return!1;for(Yt();ae();)Yt();return Ee(),!0},Yt=function(){n+=Pe()},Zt=function(){e=o},$t=function(){null==e||o<e||(o-=o-e,n="",e=void 0)},te=function(){var t=n;return n="",t},ee=function(){return o<i.length},ne=function(t,e,n){var i=!n;return e||Ee(),Oe()==t&&(i&&o++,!0)},ie=function(){return ne("<")},re=function(){return ne(">")},oe=function(){return ne("-")},se=function(){return ne("-")},ue=function(t){return!isNaN(parseInt(t))},ae=function(){var t=ue(Oe());return t&&o++,t},ce=function(){return ne("*")},he=function(){return ne(".")},fe=function(){return("\\"!=Pe()||"'"!=Oe()||!r)&&ne("'",!0)},le=function(){return("\\"!=Pe()||'"'!=Oe()||!r)&&ne('"',!0)},de=function(){return("\\"!=Pe()||"`"!=Oe()||!r)&&ne("`",!0)},pe=function(){return ne(":")},ge=function(){return ne("=")},ve=function(){return ne(",")},ye=function(){return ne("\\",!0)},we=function(t,e){return ne("(",e,t)},xe=function(){return ne(")")},be=function(){return ne("{")},me=function(){return ne("}")},Re=function(){return ne("[")},Ne=function(){return ne("]")},Ee=function(){for(;" "==Oe()||"\n"==Oe()||"\t"==Oe()||"\r"==Oe();)o++},Pe=function(){return i.charAt(o-1)},Oe=function(){return i.charAt(o)},Ie=function(t){return et(),t+' Parsed "'+i.substring(0,o)+'". Got "'+Oe()+'"'}}(this);this.execute=function(t,e,o){_e.clear();var s=arguments.callee;try{self.onerror=function(t,e,n,i,r){console.log(t),o(t),p(s)}}catch(t){}try{He.parse(t),this.run(e)}catch(t){o(t),p(s),console.log(t)}},this.addGraph=function(t,e){for(var n=0;n<t.length;n++)Fe.addNode(t[n]);for(n=0;n<e.length;n++)Fe.addRelationship(e[n])},this.resetDataBase=function(){Fe=new e(this)},this.setDataDownloadProxy=function(t){g=t},this.getDataDownloadProxy=function(){return g},this.db=function(){return Fe},this.optional=function(){return this},this.match=function(){return _e.addOperation(new i(_e)),this},this.pattern=function(){return _e.context().addPattern(),this},this.node=function(){return _e.context().addNode(new Ae(Fe)),this},this.relationship=function(){return _e.context().addRelationship(new Be(Fe)),this},this.expression=function(){return _e.context().expression(He.getExpression()),this},this.variable=function(t){return _e.context().variable(t),this},this.variableExists=function(t){return _e.hasVariable(t)},this.getVariable=function(t){return _e.getVariable(t)},this.lastObject=function(){return _e.context().getLast()},this.label=function(t){return _e.context().getLast().setLabel(t),this},this.type=function(t){return _e.context().getLast().setType(t),this},this.readProperty=function(t){return _e.context().getLast().readProperty(t),this},this.propertyValue=function(){return _e.context().getLast().setProperty(_e.getPropertyKey(),He.getExpression()),this},this.propertyKey=function(t){return _e.setPropertyKey(t),this},this.as=function(t){return _e.context().getLast().setAlias(t),this},this.leftDirection=function(){return _e.context().getLast().setLeftDirection(!0),this},this.setter=function(){return _e.addOperation(new n),this},this.relStart=function(){return this},this.relMiddle=function(){return this},this.relEnd=function(){return this},this.rightDirection=function(){return _e.context().getLast().setRightDirection(!0),this},this.variableProperty=function(t){return this},this.equals=function(){return this},this.constant=function(t){return _e.context().constant(t),this},this.load=function(){return _e.addOperation(new h(_e)),this},this.csv=function(){return _e.context().csv(),this},this.json=function(){return _e.context().json(),this},this.headers=function(){return _e.context().headers(),this},this._with=function(){return _e.addOperation(new o(_e)),this},this._return=function(){return _e.addOperation(new r(_e)),this},this.merge=function(){return _e.addOperation(new c(_e)),this},this.unwind=function(){return _e.addOperation(new s(_e)),this},this.limit=function(t){return _e.context().limit(t),this},this.where=function(t){return _e.context().where(t),this},this.statement=function(){return _e},this.operation=function(){return _e.context().type()},this.context=function(){return _e.context().getLast()},this.operationContext=function(){return _e.context()},this.run=function(t){switch(_e.context().type()){case"Match":case"With":throw"A "+_e.context().type()+"-statement cannot conclude the query."}_e.operations()[0].run(t)}}var Cypher_context_is_worker=!this.document,isNodeJS=!1,Cypher_script_path=function(){if(Cypher_context_is_worker)return"";var t=this.document.getElementsByTagName("script");return t[t.length-1].src}();try{module&&(isNodeJS=!0)}catch(t){isNodeJS=!1}function Cypher(t){var e=!t||!t.runAsWebWorker;if(Cypher_context_is_worker&&!e)try{var i=new DB;t.dataDownloadProxy&&i.setDataDownloadProxy(t.dataDownloadProxy),self.onmessage=function(t){var e=t.data,n=e.action;switch(n){case"query":return void i.execute(e.statementText,function(t){self.postMessage({action:n,success:!0,results:t})},function(t){self.postMessage({action:n,error:!0,message:t})});case"addGraph":try{i.addGraph(e.nodes,e.edges)}catch(t){return void self.postMessage({action:n,error:!0,message:t})}return void self.postMessage({action:n,success:!0});case"resetDataBase":return i.resetDataBase(),void self.postMessage({action:n})}}}catch(t){}else if(Cypher_context_is_worker||e){if(isNodeJS||!isNodeJS&&!Cypher_context_is_worker&&e){i=new DB;t&&t.dataDownloadProxy&&i.setDataDownloadProxy(t.dataDownloadProxy),this.execute=function(t,e,n){i.execute(t,e,n)}}}else{var r,o,s=new Worker(Cypher_script_path);s.onmessage=function(t){var e=t.data;switch(e.action){case"query":case"addGraph":return void(e.success?r(e.results):e.error&&o(e.message));case"resetDataBase":return void(r&&r())}},this.execute=function(t,e,n){r=e,o=n,s.postMessage({action:"query",statementText:t})},this.addGraph=function(t,e,n,i){r=n,o=i,s.postMessage({action:"addGraph",nodes:t,edges:e})},this.resetDataBase=function(t){t?r=_successCallback:t||(r=function(){}),s.postMessage({action:"resetDataBase"})}}}Cypher_context_is_worker&&new Cypher;try{module.exports={Cypher:Cypher}}catch(t){}
