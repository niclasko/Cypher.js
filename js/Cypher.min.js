// https://github.com/niclasko/Cypher.js Copyright 2019 Niclas Kj√§ll-Ohlsson.
function CypherJS(){function A(){var o=[{},null],u=1;this.recode=function(t){if(!t)return t;var e=t;e.charAt||(e=""+t);for(var n,i=o,r=0;r<e.length;r++)n=e.charAt(r),i[0][n]||(i[0][n]=[{},null]),i=i[0][n];return i[1]||(i[1]=u++)}}function t(h){function l(t){return n.recode(t)}function c(t,e){null!=t&&(R[t]||(R[t]={}),null!=e&&(R[t][e]||(R[t][e]=[])))}function s(t,e,n){c(t,e),R[t][e].push(n),o(t,n)}function d(t,e){w[t]||(w[t]={}),w[t][e]||(w[t][e]=[])}function a(t,e){E[t]||(E[t]={}),E[t][e]||(E[t][e]=[])}function p(t){b[t]||(b[t]=[])}function f(t){if(!O[t])return!(O[t]=[])}function i(t,e){if(e){if(e){if(v[e])throw"Node with ID "+e+" already exists in the database.";t.setId(e),v[e]=t}}else t.setId(function(){for(;v[y];)y++;return y}()),v[t.id()]=t;for(key in t.getRawProperties())n=key,i=t.getLocalProperty(key),r=t.id(),void 0,o=l(n),u=l(i),d(o,u),w[o][u].push(r);var n,i,r,o,u,s,a,c;for(label in t.labels())s=label,a=t.id(),void 0,c=l(s),p(c),b[c].push(a);h.statement().setNodesAdded(h.statement().getNodesAdded()+1)}function r(t,e){if(e){if(e){if(v[e])throw"Relationship with ID "+e+" already exists in the database.";t.setId(e),t[e]=t}}else t.setId(function(){for(;m[x];)x++;return x}()),m[t.id()]=t;for(key in s(t.getFromNode().id(),t.getToNode().id(),t.id()),t.getToNode().id()!=t.getFromNode().id()&&s(t.getToNode().id(),t.getFromNode().id(),t.id()),t.getProperties())n=key,i=t.getProperty(key),r=t.id(),void 0,o=l(n),u=l(i),a(o,u),E[o][u].push(r);var n,i,r,o,u;!function(t,e){var n=l(t);f(n),O[n].push(e)}(t.getType(),t.id()),t.setIsAdded(),h.statement().setRelationshipsAdded(h.statement().getRelationshipsAdded()+1)}function g(t,e,n){var i,r=[];if(t.isReferred()){if(t.isReferred()){var o=t.getReferredRelationship().getData();if(!o)throw"Expected relationship.";if(o.constructor!=Ke&&o.constructor!=B)throw"Expected relationship.";r.push(o.id())}}else e&&n?(i=function(t,e){if(c(t,e),null!=t){if(null!=e)return R[t][e];if(null==e){var n=[];for(nodeId in R[t])n=n.concat(R[t][nodeId]);return n}}return[]}(e.id(),n.id()))&&(r=r.concat(i)):e&&!n&&(i=function(t){return N[t]}(e.id()))&&(r=r.concat(i));if(0==r.length)return!1;var u=new I;for(key in u.setMatchingSet(r,0),(t.leftDirection()||t.rightDirection())&&u.incrementToMatchCount(),t.getType()&&u.incrementToMatchCount(),t.getProperties())u.incrementToMatchCount();if(0<u.toMatchCount()){for(var s,a=0;a<r.length;a++)for(key in s=m[r[a]],(t.leftDirection()||t.rightDirection())&&(t.leftDirection()!=s.leftDirection(e.id())&&t.rightDirection()!=s.rightDirection(e.id())||u.keepMatchTally(r[a])),t.getType()&&s.getType()&&s.getType()==t.getType()&&u.keepMatchTally(r[a]),t.getProperties())t.getLocalProperty(key)==s.getLocalProperty(key)&&u.keepMatchTally(r[a]);u.updateMatchingSet()}return 0!=u.matchingSetSize()&&u.matchingSet()}var v=[],y=0,w={},b={},m=[],x=0,R={},N={},E={},O={},e={},n=new A,o=function(t,e){N[t]||(N[t]=[]),N[t].push(e)};function I(){var r=0,o=[],u=[];this.setMatchingSet=function(t,e){u=t,o=new Array(u.length).fill(null!=e?e:1)},this.addToMatchingSet=function(t){u.push(parseInt(t)),o.push(0)},this.updateMatchingSet=function(){for(var t=0,e=0;e<u.length;e++)o[e]==r&&t++;var n=new Array(t),i=0;for(e=0;e<u.length;e++)o[e]==r&&(n[i++]=u[e]);u=n,o=new Array(u.length).fill(r)},this.incrementToMatchCount=function(){r++},this.keepMatchTally=function(t){for(var e=0;e<u.length;e++)u[e]==t&&(o[e]=o[e]+1||1)},this.toMatchCount=function(){return r},this.matchingSet=function(){return u},this.matchingSetSize=function(){return u.length}}this.createNode=function(t){var e;if(t.isReferred()?e=t.getReferredNode().getData():(t.bindProperties(),e=t.copy(),i(e),t.addMatchedNode(e)),t.outgoingRelationship()&&t.outgoingRelationship().setFromNode(e),t.incomingRelationship()){t.incomingRelationship().bindProperties(),t.incomingRelationship().setToNode(e);var n=t.incomingRelationship().copy();r(n),t.incomingRelationship().addMatchedRelationship(n)}t.nextNode()?t.nextNode().create():t.nextNode()||t.nextAction()};function P(t,e,n){if(t.nextNode()){if(t.getPattern().usedAsCondition())return t.nextNode().convey(e,n);t.nextNode().convey(e,n)}else if(!t.nextNode()){if(t.getPattern().usedAsCondition())return t.nextAction();t.nextAction()}}this.matchNode=function(t,e,n){var i=[];if(t.isExpanded())t.isExpanded()&&(i=[t.getExpandedNode().id()]);else{var r=new I;if(t.isReferred()){var o=t.getReferredNode().getData();if(!o)throw"Expected node.";if(o.constructor!=ke&&o.constructor!=T)throw"Expected node.";r.addToMatchingSet(o.id())}if(t.incomingRelationship()&&t.incomingRelationship().hasExpandedEndNode()&&!t.isReferred()&&r.addToMatchingSet(t.incomingRelationship().getExpandedEndNode().id()),function(t,e){var n,i,r,o,u;for(key in t.getProperties()){if(t.bindProperty(key),0==e.toMatchCount()&&0==e.matchingSetSize())i=key,r=t.getLocalProperty(key),void 0,o=l(i),u=l(r),d(o,u),(n=w[o][u])&&e.setMatchingSet(n);else if(0<e.matchingSetSize())for(var s=0;s<e.matchingSetSize();s++)t.getLocalProperty(key)==v[e.matchingSet()[s]].getLocalProperty(key)&&e.keepMatchTally(e.matchingSet()[s]);e.incrementToMatchCount(),e.updateMatchingSet()}}(t,r),function(t,e){var n,i,r;for(label in t.labels()){if(0==e.toMatchCount()&&0==e.matchingSetSize())i=label,void 0,r=l(i),p(r),(n=b[r])&&e.setMatchingSet(n);else if(0<e.matchingSetSize())for(var o=0;o<e.matchingSetSize();o++)v[e.matchingSet()[o]].hasLabel(label)&&e.keepMatchTally(e.matchingSet()[o]);e.incrementToMatchCount(),e.updateMatchingSet()}}(t,r),0==(i=function(t){var e=[];if(0<t.matchingSetSize())e=t.matchingSet();else if(0==t.toMatchCount()){e=new Array(v.length);for(var n=0;n<v.length;n++)e[n]=v[n].id()}return e}(r)).length&&e)return!t.getPattern().usedAsCondition()&&void t.getPattern().create()}for(var u=0;u<i.length;u++){var s=i[u];if(!t.incomingRelationship()&&!t.outgoingRelationship()){if(t.addMatchedNode(v[s]),t.getPattern().usedAsCondition())return P(t,e,n);P(t,e,n)}if(t.outgoingRelationship()){t.isExpanded()||(t.addMatchedNode(v[s]),t.outgoingRelationship().setFromNode(v[s]));var a=null;t.outgoingRelationship().getNextObject().isReferred()&&(a=t.outgoingRelationship().getNextObject().getReferredNode().getData()),t.outgoingRelationship().bindProperties();var c=g(t.outgoingRelationship(),v[s],a);if(!c&&e)return void t.getPattern().create();if(0<c.length)for(var h,f=0;f<c.length;f++)if(h=m[[c[f]]],t.outgoingRelationship().addMatchedRelationship(h,{fromNodeId:s,toNodeId:h.getToNode(s).id()}),t.outgoingRelationship().visitedBefore(h.getToNode(s).id()))t.outgoingRelationship().backTrackExpandedPath();else{if(t.outgoingRelationship().pathLengthSatisfied()){if(t.outgoingRelationship().setExpandedEndNode(h.getToNode(s)),t.getPattern().usedAsCondition())return P(t,e,n);P(t,e,n),t.outgoingRelationship().setExpandedEndNode(null)}t.outgoingRelationship().expandPath()&&t.outgoingRelationship().pathLengthSatisfied()&&(t.setExpandedNode(h.getToNode(s)),this.matchNode(t,!1,(n||0)+1),t.outgoingRelationship().backTrackExpandedPath(),t.setExpandedNode(null)),t.outgoingRelationship().expandPath()&&!n&&t.outgoingRelationship().backTrackExpandedPath()}}if(t.incomingRelationship()&&(t.addMatchedNode(v[s]),t.incomingRelationship().hasExpandedEndNode())){if(t.getPattern().usedAsCondition())return P(t,e,n);P(t,e,n)}}if(t.getPattern().usedAsCondition())return!1},this.getNodeById=function(t){return v[t]},this.getRelationshipById=function(t){return m[t]},this.addNode=function(t){var e=new ke(this);e.setProperties(t.properties),e.setLabels(t.labels),i(e,t.id)},this.addRelationship=function(t){var e=new Ke(Ye);e.setFromNode(this.getNodeById(t.from)),e.setToNode(this.getNodeById(t.to)),e.setProperties(t.properties),e.setType(t.type),r(e,t.id)},this.addTable=function(t){e[t.name()]=t},this.getTable=function(t){if(!(t in e))throw'Table "'+t+'" does not exist.';return e[t]}}function ke(t){var e,n,i,r,o,u=t,s={},a={},c={},h=null,f=null,l=this,d=!1;this.setPreviousObject=function(t){i=t},this.getPreviousObject=function(){return i},this.setNextObject=function(t){r=t},this.getNextObject=function(){return r},this.setPattern=function(t){o=t},this.getPattern=function(){return o},this.nextNode=function(){if(l.getNextObject()){if(l.getNextObject().isRelationship())return l.getNextObject().getNextObject();if(l.getNextObject().isNode())return l.getNextObject()}return null},this.previousNode=function(){if(l.getPreviousObject()){if(l.getPreviousObject().isRelationship())return l.getPreviousObject().getPreviousObject();if(l.getPreviousObject().isNode())return l.getPreviousObject()}return null},this.incomingRelationship=function(){return l.getPreviousObject()&&l.getPreviousObject().isRelationship()?l.getPreviousObject():null},this.outgoingRelationship=function(){return l.getNextObject()&&l.getNextObject().isRelationship()?l.getNextObject():null},this.setId=function(t){e=t},this.id=function(){return e},this.getId=this.id,this.setProperty=function(t,e){c[t]=null,a[t]=e.value},this.setProperties=function(t){for(var e in t)c[e]=t[e]},this.bindProperty=function(t){c[t]=a[t]()},this.bindProperties=function(){for(var t in c)this.bindProperty(t)},this.setLabel=function(t){s[t]=!0},this.hasLabel=function(t){return s[t]},this.setLabels=function(t){for(var e in t)s[e]=t[e]},this.setVariableKey=function(t){n=t},this.getVariableKey=function(){return n},this.hasVariableKey=function(){return null!=n},this.getProperties=function(){return Object.create(c)},this.getRawProperties=function(){return c},this.labels=function(){return s},this.getLabels=function(){return Object.keys(s)},this.hasLabels=function(){return 0<Object.keys(s).length},this.hasProperties=function(){return 0<Object.keys(c).length};function p(t){var e=this;for(var n in t)this[n]=t[n];this.getId=function(){return e.id},this.getData=function(){return e},this.getObject=function(){return e},this.groupByKey=function(){return e.id},this.groupByValue=function(){return e}}var g;this.get=function(t){return t?e:new T(u,e)},this.toObject=function(){return new p({id:e,labels:this.getLabels(),properties:P(c),getProperty:function(){return c[key]},getProperties:function(){return this.properties},getLabels:function(){return this.labels},getKeys:function(){return this.properties.getKeys()}})},this.toString=function(){return JSON.stringify(this.get())},this.type=function(){return this.constructor.name},this.isRelationship=function(){return!1},this.isNode=function(){return!0},this.setReferredNode=function(t){h=t},this.isReferred=function(){return null!=h},this.getReferredNode=function(){return h},this.setExpandedIsMatched=function(){d=!0},this.expandedIsMatched=function(){return!!d&&!(d=!1)},this.setExpandedNode=function(t){f=t},this.isExpanded=function(){return null!=f},this.getExpandedNode=function(){return f},this.nextAction=function(){},this.setNextAction=function(t){this.nextAction=t},this.convey=function(t,e){return u.matchNode(l,t,e)},this.create=function(){return u.createNode(l)},this.merge=function(){return u.mergeNode(l)},this.match=function(){return u.matchNodes(l)};var v={};this.addMatchedNode=function(t){g=t.id()},this.getMatchedNode=function(){return this.getData()},this.addMatchedIncomingRelationshipId=function(t,e){v[t]||(v[t]=[]),v[t].push(e)},this.getMatchedIncomingRelationshipIds=function(t){if(!v[t])return null;var e=v[t];return v[t]=[],e},this.getData=function(){return u.getNodeById(g)},this.getLocalProperty=function(t){return c[t]||null},this.getProperty=function(t){return u.getNodeById(g)?u.getNodeById(g).getLocalProperty(t):null},this.groupByKey=function(){return this.getData().id()},this.groupByValue=function(){return this.getData().get()},this.copy=function(){var t=new ke(u);return t.setLabels(s),t.setProperties(c),t},this.mappable=function(){if(h&&h.mappable&&!h.mappable())return!1;for(var t in c)if(!a[t].mappable())return!1;return!0}}function Ke(t){var e,n,i,r,o,u,s,a,c,h,f=t,l={},d={},p=!1,g=!1,v=1,y=1,w=null;this.setPreviousObject=function(t){a=t},this.getPreviousObject=function(){return a},this.setNextObject=function(t){c=t},this.getNextObject=function(){return c},this.setPattern=function(t){h=t},this.getPattern=function(){return h},this.setId=function(t){e=t},this.id=function(){return e},this.setType=function(t){n=t},this.getType=function(){return n},this.setProperty=function(t,e){l[t]=null,d[t]=e.value},this.bindProperty=function(t){l[t]=d[t]()},this.bindProperties=function(){for(var t in l)this.bindProperty(t)},this.setProperties=function(t){for(var e in t)l[e]=t[e]},this.getProperty=function(t){return l[t]},this.getProperties=function(){return l},this.setFromNode=function(t){i=t},this.setToNode=function(t){r=t},this.getFromNode=function(t){return null!=t&&t!=i.id()?r:i},this.getToNode=function(t){return null!=t&&t!=i.id()?i:r},this.setLeftDirection=function(t){o=t},this.setRightDirection=function(t){u=t},this.leftDirection=function(t){return null!=t&&t!=i.id()?!o&&u:o&&!u},this.rightDirection=function(t){return null!=t&&t!=i.id()?!u&&o:u&&!o},this.uniDirectional=function(){return u&&o},this.noDirection=function(){return!o&&!u},this.type=function(){return this.constructor.name},this.isRelationship=function(){return!0},this.isNode=function(){return!1},this.setReferredRelationship=function(t){w=t},this.isReferred=function(){return null!=w},this.getReferredRelationship=function(){return w},this.isAdded=function(){return p},this.setIsAdded=function(){p=!0},this.setHasVariablePathLength=function(){g=!0,y=v=null},this.hasVariablePathLength=function(){return g},this.setPathLengthFrom=function(t){v=t},this.pathLengthFrom=function(){return v},this.setPathLengthTo=function(t){y=t},this.pathLengthTo=function(){return y},this.expandPath=function(){return g};function b(t){for(var e in t)this[e]=t[e];this.getId=function(){return this.id},this.getData=function(){return this},this.getObject=function(){return this},this.groupByKey=function(){return this.id},this.groupByValue=function(){return this}}var m;this.get=function(){return new B(f,e)},this.toObject=function(){return new b({id:e,type:n,properties:P(l),fromNode:i?i.get():null,toNode:r?r.get():null,getProperty:function(){return l[key]},getProperties:function(){return this.properties},getKeys:function(){return this.properties.getKeys()},getType:function(){return n}})},this.toString=function(){var t="none";return this.leftDirection()?t="left":this.rightDirection()&&(t="right"),"id: "+e+". type: "+n+". properties: "+JSON.stringify(l)+". fromNodeId: "+(i?i.id():null)+". toNodeId: "+(r?r.id():null)+". direction: "+t},this.value=function(){return this.get()},this.setVariableKey=function(t){s=t},this.getVariableKey=function(){return s},this.hasVariableKey=function(){return null!=s},this.nextAction=function(){},this.setNextAction=function(t){this.nextAction=t},this.visitedBefore=function(t){return 1==O[t]};function x(t){O[t]=(O[t]||0)+1}var R,N=[],E=[],O={},I=null;this.visitedBefore=function(t){return 1<N.length&&N[N.length-1]==N[N.length-2]||2<=O[t]},this.addMatchedRelationship=function(t,e){m=t.id(),g&&(N.push(m),E.push(e),function(t){0==N.length&&x(t.fromNodeId),x(t.toNodeId)}(e))},this.getMatchedRelationship=function(){return this.getData()},this.hasExpandedEndNode=function(){return null!=I},this.setExpandedEndNode=function(t){I=t},this.getExpandedEndNode=function(){return I},this.setMatchingRelationshipIds=function(t){R=t},this.getMatchingRelationshipIds=function(){var t=null;return R&&(t=R.slice()),R=null,t},this.expandedPathLastItem=function(){return N[N.length-1]},this.backTrackExpandedPath=function(){if(0!=N.length){N.pop();var t=E.pop();0==N.length?O={}:O[t.toNodeId]--}},this.pathLengthFromSatisfied=function(){return!this.expandPath()||null==v||v&&N.length>=v},this.pathLengthToSatisfied=function(){return!this.expandPath()||null==y||y&&N.length<=y},this.pathLengthSatisfied=function(){return this.pathLengthFromSatisfied()&&this.pathLengthToSatisfied()},this.getData=function(){return g?new _e(N,function(t){return f.getRelationshipById(t).value()}):f.getRelationshipById(m)},this.getLocalProperty=function(t){return l[t]||null},this.getProperty=function(t){return f.getRelationshipById(m)?f.getRelationshipById(m).getLocalProperty(t):null},this.groupByKey=function(){return this.getData().id()},this.groupByValue=function(){return this.getData().get()},this.copy=function(){var t=new Ke(f);return t.setType(n),t.setProperties(l),t.setLeftDirection(o),t.setRightDirection(u),t.setFromNode(i),t.setToNode(r),t},this.mappable=function(){if(w&&w.mappable&&!w.mappable())return!1;for(var t in l)if(!d[t].mappable())return!1;return!0}}function Ge(){function e(t){r.empty()||(r.lastObject().setNextObject(t),t.setPreviousObject(r.lastObject())),t.setPattern(r),n.push(t)}var n=[],i=[],u=[],r=this,t=!1;this.addNode=function(t){i.push(t),e(t)},this.addRelationship=function(t){u.push(t),e(t)},this.nodeCount=function(){return this.nodes.length},this.relationshipCount=function(){return this.relationships.length},this.getData=function(){for(var t,e,n=[],i=[],r=0;r<u.length;r++)if(u[r].hasVariablePathLength()){if(u[r].hasVariablePathLength()){e=u[r].getData().value();for(var o=0;o<e.length;o++)t=e[o].getRelationship(),n.push(t.getFromNode().get(),t.get(),t.getToNode().get()),i.push(t.id())}}else t=u[r].getData().value().getRelationship(),n.push(t.getFromNode().get(),t.get(),t.getToNode().get()),i.push(t.id());return(n=Xe(n)).getNodes=function(){for(var t=[],e=0;e<n.length;e+=3)0==e&&t.push(n[e]),t.push(n[e+2]);return Xe(t)},n.getRelationships=function(){for(var t=[],e=0;e<n.length;e+=3)t.push(n[e+1]);return Xe(t)},this.groupByKey=function(){return i},this.groupByValue=function(){return n},n},this.objects=function(){return n},this.getObject=function(t){return n[t]},this.lastObject=function(){return n[n.length-1]},this.getLast=this.lastObject,this.empty=function(){return 0==n.length},this.setNextAction=function(t){s=t};function o(){r.lastObject().setNextAction(function(){s()})}var s=function(){};this.useAsCondition=function(){t=!0,r.lastObject().setNextAction(function(){return!0})},this.usedAsCondition=function(){return t},this.value=function(){return i[0].convey(!1)},this.match=function(){o(),i[0].convey(!1)},this.merge=function(){o(),i[0].convey(!0)},this.create=function(){o(),i[0].create()},this.mappable=function(){for(var t=0;t<n.length;t++)if(!n[t].mappable())return!1;return!0}}function Fe(){function n(){for(var t in i)r[t]=i[t].value()}var i={},r={},o=[],t=this;this.addEntry=function(t,e){if(t in i)throw'Key "'+t+'" already exists in associative array.';i[t]=e,r[t]=null,o.push(t)},this.get=function(){n();var t={};for(var e in r)t[e]=r[e],t[e]&&(t[e].constructor=r[e].constructor);return P(t)},this.getProperty=function(t){return n(),r[t]},this.getProperties=function(){return Object.keys(i)},this.getValues=function(){return Object.values(i)},this.setValue=function(t,e){i[o[t]]=e},this.next=function(){return!1},this.hasNext=function(){return!0},this.reset=function(){},this.getData=function(){return t},this.getObject=function(){return t},this.value=function(){return t.get()},this.type=function(){return t.constructor.name},this.toString=function(){return n(),JSON.stringify(r)},this.groupByKey=function(){return t.toString()},this.groupByValue=function(){return t.get()}}function _e(i,r){i=i&&i.constructor==Array&&i||[];var o=Xe([]),t=this;this.add=function(t){t&&(i.push(t),o.push(null))},this.get=function(){!function(){if(r){if(r)for(t=0;t<i.length;t++)o[t]=r(i[t])}else for(var t=0;t<i.length;t++)o[t]=i[t].value()}();for(var t=new Array(o.length),e=0;e<o.length;e++)if(o[e].constructor!=T&&o[e].constructor!=B)for(var n in t[e]=o[e],t[e].constructor=o[e].constructor,o[e])t[e][n]&&(t[e][n].constructor=o[e][n].constructor);else t[e]=o[e];return Xe(t)},this.setElement=function(t,e){i[t]=e},this.getElements=function(){return i},this.next=function(){return!1},this.hasNext=function(){return!0},this.reset=function(){},this.getData=function(){return t},this.value=function(){return t.get()},this.type=function(){return t.constructor.name},this.groupByKey=function(){return t.get()},this.groupByValue=function(){return t.get()}}function He(){var e,t=this,n=[],i=[];this.when=function(t){n.push(t)},this.whenCount=function(){return n.length},this.then=function(t){i.push(t)},this.else=function(t){e=t},this.get=function(){return this.value()},this.next=function(){return!1},this.hasNext=function(){return!0},this.reset=function(){},this.getData=function(){return t},this.value=function(){for(var t=0;t<n.length;t++)if(n[t].value())return i[t].value();return e.value()},this.type=function(){return t.constructor.name},this.groupByKey=function(){return t.get()},this.groupByValue=function(){return t.get()}}function Ue(t){var e=t;this.get=function(){return e},this.next=function(){return!1},this.hasNext=function(){return!0},this.reset=function(){},this.getData=function(){return this},this.getObject=function(){return e},this.value=function(){return e},this.id=function(){return e.id},this.setValue=function(t){e=t},this.type=function(){return this.constructor.name},this.groupByKey=function(){return e},this.groupByValue=function(){return e}}function u(t,e){var n=t,i=e,r={};this.addColumn=function(t){return r[t]=new o(this,t),r[t]},this.addValue=function(t,e){r[t].addValue(e)},this.getColumn=function(t){return r[t]},this.name=function(){return i},n.addTable(this)}function o(t,e){var n=e,i=[],r=[],o=0,u=0;this.addValue=function(t){0<r.length?r[r.length-1]==t?i[i.length-1]++:r[r.length-1]!=t&&(r.push(t),i.push(1)):0==r.length&&(r.push(t),i.push(1))},this.value=function(){return u>i[o]&&(u=0,o++),u++,r[o]},this.reset=function(){u=o=0},this.name=function(){return n}}var a=new function(){this.get=function(t,e,n){var i=function(){try{return new XMLHttpRequest}catch(t){}return new function(){this.UNSENT=0,this.OPENED=1,this.HEADERS_RECEIVED=2,this.LOADING=3,this.DONE=4,this.readyState=this.UNSENT,this.status=null,this.responseText=null,this.response=null,this.responseType=null,this.method=null,this.url=null,this.async=!0,this.onreadystatechange=function(){},this.onload=function(){},this.open=function(t,e,n){this.method=t,this.url=e,this.async=n,this.readyState=this.OPENED},this.send=function(){var t=null;try{t=require("https")}catch(t){}var n=this;t.get(this.url,function(t){var e="";t.on("data",function(t){e+=t}),t.on("end",function(){n.responseText=e,n.response=e,n.readyState=n.DONE,n.status=200,n.onreadystatechange()})}).on("error",function(t){console.log("Error: "+t),n.status=0,n.onreadystatechange()}),this.onload(this)}}}();i.onreadystatechange=function(){4==i.readyState&&(200==i.status?e(i.responseText):200!=i.status&&(0==i.status?n('Access denied for URL resource "'+t+'".'):404==i.status&&n('URL resource "'+t+'" not found.')))},i.open("GET",t,!0),i.send()}};function ze(t,e,n,i,r,o){var u=t,s=u.element&&u.element().getKey?u.element().getKey():e,a=n,c=i,h=r;if(a){c.addReduceExpression(this);for(var f=0;f<a.length;f++)a[f].setGroupBy(c.getGroupBy()),a[f].setReducer(c.getGroupBy().addReducer()),a[f].initialize()}if(this.root=function(){return u},this.rootObject=function(){return u.element().getObject?u.element().getObject():u.element()},this.value=function(){return u.value()},this.getData=function(){return this.value()},this.getAlias=function(){return s},this.variableReferences=function(){return h},this.hasReferredVariables=function(){return h&&0<h.length},this.setAlias=function(t){t=t},this.hasKey=function(){return u.hasKey&&u.hasKey()},this.isReduceExpression=function(){return null!=a},this.aggregate=function(){if(a)for(var t=0;t<a.length;t++)a[t].aggregate();else c.getGroupBy().map(u)},this.hasAggregateFunctions=function(){return null!=a},this.isArray=function(){return u.element().constructor==_e},this.isAssociativeArray=function(){return u.element().constructor==Fe},this.getAggregateFunctions=function(){return a},this.type=function(){return this.constructor.name},u.element().constructor==_e){var l=u.element().getElements();for(f=0;f<l.length;f++)return void(l[f].hasAggregateFunctions&&(this.hasAggregateFunctions=function(){return!0}))}u.non_deterministic=function(){return o},this.mappable=function(){return u.mappable()}}function d(t,e){var n=t,i=e,r=null;this.getObjectKey=function(){return i},this.getObject=function(){return r||(n.constructor==Ue?n.getObject():n)},this.value=function(t){if(r)return r;try{return n.getData().get(t)}catch(t){}return null},this.setOverriddenValue=function(t){r=t}}function x(t){var e=t;this.evaluate=function(){return 1==e.value()}}function e(t,e){var i,n,r=[],o=new u(t,e);this.setPreviousOperation=function(t){var e;i=t;for(var n=0;n<i.variables().length;n++)e=i.variables()[n],r.push(o.addColumn(e.getObjectKey()))},this.setNextOperation=function(t){(n=t).setPreviousOperation(this)},this.variables=function(){return i.variables()},this.doIt=function(){for(var t,e=0;e<i.variables().length;e++)t=i.variables()[e],r[e].addValue(r[e].name(),t.value());n&&n.doIt()},this.finish=function(){n&&n.finish()},this.run=function(t){throw"Into-operation cannot be first in statement."},this.type=function(){return this.constructor.name}}function n(){var i,e,n;function r(t,e,n){var i=t,r=e,o=n;this.set=function(){var t,e=i.getObject();if(e.constructor==f&&(e=e.value()),e.constructor==T)t=e.getObject();else if(e.constructor==ke)t=e.getData();else if(e.constructor==B)t=e.getObject();else{if(e.constructor!=Ke)throw'Cannot assign to object of type "'+e.constructor.name+'".';t=e.getData()}t.setProperty(r,o),t.bindProperty(r)}}this.addSetter=function(t,e,n){(i=i||[]).push(new r(t,e,n))},this.setPreviousOperation=function(t){e=t},this.setNextOperation=function(t){(n=t).setPreviousOperation(this)},this.variables=function(){return e.variables()},this.doIt=function(){for(var t=0;t<i.length;t++)i[t].set();n&&n.doIt()},this.finish=function(){n&&n.finish()},this.run=function(t){throw"Set-operation cannot be first in statement."},this.type=function(){return this.constructor.name}}function i(t){var e,n,i,r=t,o=[];this.where=function(t){i=new x(t)},this.addPattern=function(){o.push(new Ge)};function u(){return o[o.length-1]}this.getPattern=function(){return u()},this.addNode=function(t){u().addNode(t)},this.addRelationship=function(t){u().addRelationship(t)},this.variable=function(t){r.addVariable(t,this.getLast())},this.getLast=function(t){return u().lastObject()},this.setPreviousOperation=function(t){e=t},this.setNextOperation=function(t){(n=t).setPreviousOperation(this)},this.previousOperation=function(){return e};function s(){n&&u().setNextAction(function(){i&&!i.evaluate()||n.doIt()})}this.doIt=function(){if(e.constructor==c)throw"WITH is required between MERGE and CREATE";s(),this.doIt=function(){for(var t=0;t<o.length;t++)o[t].create()},this.doIt()},this.finish=function(){n&&n.finish()},this.run=function(t){s();for(var e=0;e<o.length;e++)o[e].create();n&&n.finish(),t(r.results())},this.type=function(){return this.constructor.name},this.variables=function(){return r.variables()}}function r(t){var e,n,i,r=t,o=[];this.where=function(t){i=new x(t)},this.addPattern=function(){o.push(new Ge)};function u(){return o[o.length-1]}this.getPattern=function(){return u()},this.addNode=function(t){u().addNode(t)},this.addRelationship=function(t){u().addRelationship(t)},this.variable=function(t){r.addVariable(t,this.getLast())},this.getLast=function(t){return u().lastObject()},this.setPreviousOperation=function(t){e=t},this.setNextOperation=function(t){(n=t).setPreviousOperation(this)},this.previousOperation=function(){return e};function s(){n&&u().setNextAction(function(){i&&!i.evaluate()||n.doIt()})}this.doIt=function(){if(e.constructor==c)throw"WITH is required between MERGE and MATCH";s(),this.doIt=function(){for(var t=0;t<o.length;t++)o[t].match()},this.doIt()},this.finish=function(){n&&n.finish()},this.run=function(t){s();for(var e=0;e<o.length;e++)o[e].match();n&&n.finish(),t(r.results())},this.type=function(){return this.constructor.name},this.variables=function(){return r.variables()}}function c(t){var e,n,i,r=t,o=[];this.where=function(t){i=new x(t)},this.addPattern=function(){o.push(new Ge)};function u(){return o[o.length-1]}this.addNode=function(t){u().addNode(t)},this.addRelationship=function(t){u().addRelationship(t)},this.getLast=function(t){return u().lastObject()},this.variable=function(t){this.getLast().setVariableKey(t),r.addVariable(t,this.getLast())},this.setPreviousOperation=function(t){e=t},this.setNextOperation=function(t){(n=t).setPreviousOperation(this)},this.previousOperation=function(){return e};function s(){n&&u().setNextAction(function(){i&&!i.evaluate()||n.doIt()})}this.doIt=function(){s(),this.doIt=function(){u().merge()},this.doIt()},this.finish=function(){n&&n.finish()},this.run=function(t){s(),u().merge(),n&&n.finish(),t(r.results())},this.type=function(){return this.constructor.name},this.variables=function(){return r.variables()}}function R(n){n=n;function i(t){return{value:t,map:{}}}var r,t=null,e=0,o=new A;this.getTrieRoot=function(){return t},this.beginMap=function(){null==t&&(t=i()),r=t},this.beginMap(),this.map=function(t){t.non_deterministic()&&t.precalculate();var e=function(t){return null==t||null==t?t:t.constructor==T||t.constructor==B?t.id():t.constructor==Array||t.constructor==Object?JSON.stringify(t):o.recode(t)}(t.groupByKey()),n=t.groupByValue();r.map[e]||(r.map[e]=i(n)),r=r.map[e]},this.getReducer=function(t){return r.reducers||(r.reducers=new Array(e)),r.reducers[t]||(r.reducers[t]={}),r.reducers[t]},this.addReducer=function(){return e++},this.print=function(){u(t)};var u=function(t){var e;for(e in t.map)n.setNextMapValue(t.map[e].value),u(t.map[e]),n.moveToPreviousMapValue();e||(r=t,n.addAggregateOutputRecord())}}function N(t,e,n,i){var r,o=t,u=e,s=o.getAlias(),a=0,c=this,h=i,f=n;this.getAlias=function(){return s},this.setAlias=function(t){s=t,u.addVariable(s,this)},this.hasKey=function(){return o.hasKey()},this.setId=function(t){a=t},this.getId=function(){return a},this.value=function(){return null!=r?r:o.value()},this.groupByKey=function(){return this.value()},this.groupByValue=function(){return this.value()},this.get=function(){return c.value()},this.getData=function(){return c},this.getExpression=function(){return o},this.setGroupByValue=function(t){o.isArray()&&o.hasAggregateFunctions()||(r=t)},this.nextAction=function(){},this.setNextAction=function(t){this.nextAction=t},this.hidden=function(){return h},this.parent=function(){return f},this.type=function(){return this.constructor.name}}function s(t){var e,c,n,i,r,o,u,h=t,f=[],s=0,a=!1,l=!1,d=this,p=0,g=0;this.where=function(t){o=new x(t)},this.limit=function(t){u=t},this.expression=function(t){w(t)},this.getLast=function(){return f[b()]},this.getGroupBy=function(){return null==e&&(e=new R(this)),e},this.hasGroupBy=function(){return null!=e},this.hasMapKeys=function(){return c&&0<c.length},this.doItCount=function(){return g};function v(){return null!=u&&p>=u.value()}function y(){return!o||o.evaluate()}this.addReduceExpression=function(t){(n=n||[]).push(t)},this.setNextMapValue=function(t){c[s++].setGroupByValue(t)},this.moveToPreviousMapValue=function(){s--},this.addAggregateOutputRecord=function(){if(y()&&!(0==this.doItCount()&&this.hasMapKeys()||v())){for(var t=0;t<f.length;t++)f[t].nextAction();p++,r&&r.doIt()}},this.setReturnValueNextAction=function(t){t.setNextAction(function(){0==t.getId()&&h.addOutputRecord(),t.hidden()||h.addOutputEntry(t.getAlias(),t.value(),t.getId())})};var w=function(t,e){var n=!1;if(t.isArray())for(var i=t.root().element(),r=0;r<i.getElements().length;r++){var o=w(i.getElements()[r],!0);i.setElement(r,o),n=!0}else if(t.isAssociativeArray()){var u=t.root().element(),s=u.getValues();for(r=0;r<s.length;r++){o=w(s[r],!0);u.setValue(r,o),n=!0}}var a=new N(t,h,d,e);return f.push(a),f[b()].setId(b()),a.getExpression().isReduceExpression()||n||!a.getExpression().mappable()||(c=c||[]).push(a),d.setReturnValueNextAction(a),l=t.hasReferredVariables(),a};this.setIsIntermediary=function(){a=!0},this.conveyorBeltEnd=function(){return!l&&a&&!n};var b=function(){return f.length-1};this.setPreviousOperation=function(t){i=t},this.setNextOperation=function(t){(r=t).setPreviousOperation(this)},this.previousOperation=function(){return i},this.nextOperation=function(){return r},this.variables=function(){if(!r&&i)return i.variables();for(var t=[],e=0;e<f.length;e++)f[e].hidden()||t.push(h.getVariable(f[e].getAlias()));return t},this.type=function(){return this.constructor.name};function m(){if(g++,d.hasGroupBy()){if(d.hasGroupBy()){if(e.beginMap(),c)for(t=0;t<c.length;t++)c[t].getExpression().aggregate();for(t=0;t<n.length;t++)n[t].aggregate()}}else{if(!y())return;if(v())return;for(var t=0;t<f.length;t++)f[t].nextAction();p++,r&&r.doIt()}}this.doIt=function(){this.conveyorBeltEnd()||m()},this.finish=function(){this.conveyorBeltEnd()&&m(),this.hasGroupBy()&&e.print(),r&&r.finish()},this.run=function(t){m(),r&&r.finish(),t(h.results())}}function h(t){var e=new s(t),n=this.constructor.name;return e.setReturnValueNextAction=function(t){t.hidden()||t.setNextAction(function(){e.hasGroupBy()&&Ze.getVariable(t.getAlias()).setOverriddenValue(t.value())})},e.type=function(){return n},e.setIsIntermediary(),e}function f(t){var e,n,i,r,o,u=t,s=0;this.doIt=function(){if(n){if(!(r=i.value()))return;if(!r.length)throw"Unwind expects list expression.";for(s=0;s<r.length;s++)n.doIt()}},this.finish=function(){n&&n.finish()},this.run=function(t){this.doIt(),n&&n.finish(),t(u.results())},this.variable=function(t){o=t,u.addVariable(t,this)},this.variables=function(){return[u.getVariable(o)]},this.expression=function(t){i=t},this.setPreviousOperation=function(t){e=t},this.setNextOperation=function(t){(n=t).setPreviousOperation(this)},this.previousOperation=function(){return e},this.nextOperation=function(){return n},this.value=function(){return r[s]},this.groupByKey=this.value,this.groupByValue=this.value,this.get=function(){return this.value()},this.getData=function(){return this},this.type=function(){return this.constructor.name}}function l(t){var b,e,n=t,i=null,m=!1,r=",",o=null,x=null,u=null,s=n.engine().getDataDownloadProxy();this.csv=function(){i="CSV"},this.json=function(){i="JSON"},this.loadType=function(){return i},this.headers=function(){m=!0},this.setFieldTerminator=function(t){if(1<t.length||0==t.length)throw"Field terminator must be one char.";r=t},this.fieldTerminator=function(){return r},this.expression=function(t){o=t},this.getLast=function(){return o},this.variable=function(t){n.addVariable(t,this)},this.getProperty=function(t){return b[t]},this.from=function(){return s?s+o.value():o.value()},this.get=function(){return b},this.value=function(){return this.get()},this.groupByKey=function(){return b},this.groupByValue=function(){return this.get()},this.getData=function(){return this},this.statement=function(){return n},this.setPreviousOperation=function(t){e=t},this.setNextOperation=function(t){(u=t).setPreviousOperation(this)},this.previousOperation=function(){return e},this.variables=function(){return n.variables()};this.doIt=function(){this.run()},this.finish=function(){},this.run=function(e){var n=this;a.get(n.from(),function(t){"CSV"==n.loadType()?(x=t,function(t,e){function n(){return w()?"\0":x.charAt(f)}function i(){return h==d}function r(){return"\r"==h&&"\n"==n()&&p(),"\n"==h}function o(){for(var t="";!(i()||r()||w())||y();)t+=g()?(h=x.charAt(++f),'""'):h,p();0==c&&(m?u.push(t):m||u.push(u.length)),(0<c&&m||!m)&&(a[u[s++]]=t),i()&&p()}for(var u=[],s=0,a={},c=0,h="",f=0,l=!1,d=t||",",p=function(){h,h=x.charAt(f++),v()&&(l=!l,p())},g=function(){return!(!y||'"'!=h||'"'!=n())},v=function(){return!g()&&'"'==h},y=function(){return l},w=function(){return f>=x.length};!w();){for(;!r()&&!w();)o();0<c++&&(b=a,a={},s=0,e()),p()}}(n.fieldTerminator(),function(){u.doIt()})):"JSON"==n.loadType()&&function(t,e){if(t.constructor==Array)for(var n=0;n<t.length;n++)b=P(t[n]),e();else t.constructor==Object&&(b=P(t),e())}(JSON.parse(t),function(){u.doIt()}),u&&u.finish(),e&&e(n.statement().results())},function(t){throw n.type()+": "+t})},this.type=function(){return this.constructor.name}}var p=function(t){var e,n={};for(key in t){for(var i=t[key].displayValue(),r=n,o=0;o<i.length;o++)r[e=i.charAt(o).toUpperCase()]||(r[e]={}),r=r[e];r.isF=!0,r.f=t[key]}return n},g=function(t,e,n,i,r){function o(t){return n.charAt(t).toUpperCase()}for(var u,s=e,a=i;;){if(!s[o(a)])return 0;if((s=s[o(a)]).isF&&!s[o(a+1)]&&(u=a+1,r||" "==o(u)||"("==o(u)||")"==o(u)||","==o(u)||""==o(u)||"}"==o(u)))return t.latestParsed=s.f,a-i+1;a++}};function Je(t,e){t=t;this.action=e,this.displayValue=function(){return t}}function We(t,e,n,i){t=t,e=e,n=n;this.value=i,this.isOperator=!0,this.displayValue=function(){return t},this.precedence=function(){return e},this.leftAssociativity=function(){return n},this.rightAssociativity=function(){return!n}}function qe(t,e,n,i,r){var o=t,u=e,s=n,a=r;this.value=i,this.getObject=i,this.groupByKey=i,this.groupByValue=i,this.isFunction=!0,this.displayValue=function(){return o},this.parametric=function(){return 0<u},this.precedence=function(){return 12},this.leftAssociativity=function(){return!0},this.rightAssociativity=function(){return!this.leftAssociativity},this.verifyParsedParameterCount=function(t){if(t<u)throw'Too few parameters for function "'+o+'".';if(s<t)throw'Too many parameters for function "'+o+'".'},this.returnType=function(){return a}}function Qe(t,e,n,i,r,o,u){var s=t,a=0,c=e,h=n,f=u;this.initialize=i,this.value=r,this.getObject=r,this.aggregate=o,this.isFunction=!0,this.initializeIfNecessary=function(){this.initialize()},this.displayValue=function(){return s},this.precedence=function(){return 12},this.leftAssociativity=function(){return!0},this.rightAssociativity=function(){return!this.leftAssociativity},this.parametric=function(){return 0<c},this.parsedParameterCount=function(){return a},this.verifyParsedParameterCount=function(t){if((a=t)<c)throw'Too few parameters for function "'+s+'".';if(h<a)throw'Too many parameters for function "'+s+'".'},this.returnType=function(){return f}}function v(t){for(var e=t;e;)console.log(e),e=e.caller}function Xe(i){return i.contains=function(t){for(var e=0;e<i.length;e++)if(t==i[e])return!0;return!1},i.toLowerCase=function(){for(var t=[],e=0;e<i.length;e++)t.push(i[e].toLowerCase&&i[e].toLowerCase()||i[e]);return t},i.toUpperCase=function(){for(var t=[],e=0;e<i.length;e++)t.push(i[e].toUpperCase&&i[e].toUpperCase()||i[e]);return t},i.get=function(){return i},i.last=function(){return i[i.length-1]},i.beforeLast=function(){return i[i.length-2]},i.value=function(){return i},i.join=function(t){for(var e="",n=0;n<i.length;n++)e+=(0<n?t:"")+i[n];return e},i.trim=function(){for(var t=new Array(i.length),e=0;e<i.length;e++)t[e]=i[e].trim();return t},i}function P(e){return e.getProperty||(e.getProperty=function(t){return e[t]}),e.getProperties||(e.getProperties=function(){return e}),e.getKeys||(e.getKeys=function(){var t=[];for(key in e)e[key].constructor!==Function&&t.push(key);return t}),e}function y(t){if(t&&t.constructor==String)return t.replace(/\0/g,"");if(t&&(t.constructor==T||t.constructor==B))return y(t.value());if(t){for(var e in t)"function"!=typeof t[e]?t[e]&&(t[e]=y(t[e])):delete t[e];t.fromNode&&(t.fromNode=y(t.fromNode)),t.toNode&&(t.toNode=y(t.toNode))}return t}function T(t,e){var n=t,i=e;this.nodeId=function(){return i},this.id=this.nodeId,this.getNode=function(){return n.getNodeById(i)},this.getObject=function(){return n.getNodeById(i)},this.value=function(){return n.getNodeById(i).toObject()},this.getData=this.value,this.getProperty=function(t){return n.getNodeById(i).getLocalProperty(t)},this.getProperties=function(){return this.value().getProperties()},this.getLabels=function(){return this.value().getLabels()},this.getKeys=function(){return this.value().getProperties().getKeys()},this.groupByKey=this.nodeId}function B(t,e){var n=t,i=e;this.relationshipId=function(){return i},this.id=this.relationshipId,this.getRelationship=function(){return n.getRelationshipById(i)},this.getObject=function(){return n.getRelationshipById(i)},this.value=function(){return n.getRelationshipById(i).toObject()},this.startNode=function(){return this.getRelationship().getFromNode().get()},this.endNode=function(){return this.getRelationship().getToNode().get()},this.getData=this.value,this.getProperty=function(t){return n.getRelationshipById(i).getLocalProperty(t)},this.getProperties=function(){return this.value().getProperties()},this.getKeys=function(){return this.value().getProperties().getKeys()},this.getType=function(){return this.value().getType()},this.groupByKey=this.relationshipId}(Je.f={}).CREATE=new Je("CREATE",function(t){t.create()}),Je.f.MATCH=new Je("MATCH",function(t){t.match()}),Je.f.MERGE=new Je("MERGE",function(t){t.merge()}),Je.f.WITH=new Je("WITH",function(t){t._with()}),Je.f.RETURN=new Je("RETURN",function(t){t._return()}),Je.f.INTO=new Je("INTO",function(t){t.into()}),Je.f.LIMIT=new Je("LIMIT",function(t){}),Je.f.UNWIND=new Je("UNWIND",function(t){t.unwind()}),Je.f.WHERE=new Je("WHERE",function(t){}),Je.f.LOAD=new Je("LOAD",function(t){t.load()}),Je.f.CSV=new Je("CSV",function(t){t.csv()}),Je.f.JSON=new Je("JSON",function(t){t.json()}),Je.f.HEADERS=new Je("HEADERS",function(t){t.headers()}),Je.f.FROM=new Je("FROM",function(t){}),Je.f.AS=new Je("AS",function(t){}),Je.f.FIELDTERMINATOR=new Je("FIELDTERMINATOR",function(t){}),Je.f.SET=new Je("SET",function(t){}),Je.f.DISTINCT=new Je("DISTINCT",function(t){}),Je.f.TRUE=new Je("TRUE",function(t){}),Je.f.FALSE=new Je("FALSE",function(t){}),Je.f.NULL=new Je("NULL",function(t){}),Je.f.CASE=new Je("CASE",function(t){}),Je.f.WHEN=new Je("WHEN",function(t){}),Je.f.THEN=new Je("THEN",function(t){}),Je.f.ELSE=new Je("ELSE",function(t){}),Je.f.END=new Je("END",function(t){}),Je.trie=p(Je.f),Je.isKeyWord=function(t,e){return g(Je,Je.trie,t,e)},(We.f={}).POWER=new We("^",11,!1,function(){return Math.pow(this.lhs.value(),this.rhs.value())}),We.f.MULTIPLY=new We("*",10,!0,function(){return this.lhs.value()*this.rhs.value()}),We.f.DIVIDE=new We("/",10,!0,function(){return this.lhs.value()/this.rhs.value()}),We.f.MODULO=new We("%",10,!0,function(){return this.lhs.value()%this.rhs.value()}),We.f.PLUS=new We("+",9,!0,function(){return this.lhs.value().constructor==Array?this.lhs.value().concat(this.rhs.value()):this.rhs.value().constructor==Array?[this.lhs.value()].concat(this.rhs.value()):this.lhs.value()+this.rhs.value()}),We.f.MINUS=new We("-",9,!0,function(){return this.lhs.value()-this.rhs.value()}),We.f.GREATER_THAN=new We(">",8,!0,function(){return this.lhs.value()>this.rhs.value()}),We.f.LESS_THAN=new We("<",8,!0,function(){return this.lhs.value()<this.rhs.value()}),We.f.GREATER_THAN_OR_EQUALS=new We(">=",8,!0,function(){return this.lhs.value()>=this.rhs.value()}),We.f.LESS_THAN_OR_EQUALS=new We("<=",8,!0,function(){return this.lhs.value()<=this.rhs.value()}),We.f.EQUALS=new We("=",7,!0,function(){return this.lhs.value()==this.rhs.value()}),We.f.NOT_EQUALS=new We("<>",7,!0,function(){return this.lhs.value()!=this.rhs.value()}),We.f.IN=new We("IN",7,!0,function(){return this.rhs.element().value().contains||function(){throw"Not a list expression."}(),this.rhs.element().value().contains(this.lhs.value())}),We.f.IS=new We("IS",7,!0,function(){return this.lhs.value()==this.rhs.value()}),We.f.AND=new We("AND",6,!0,function(){return this.lhs.value()&&this.rhs.value()}),We.f.OR=new We("OR",5,!0,function(){return this.lhs.value()||this.rhs.value()}),We.f.NONE=new We("NONE",-1,!0,null),We.trie=p(We.f),We.latestParsed=null,We.isOperator=function(t,e){return g(We,We.trie,t,e,!0)},(qe.f={}).PI=new qe("PI",0,0,function(){return Math.PI}),qe.f.E=new qe("E",0,0,function(){return Math.E}),qe.f.exp=new qe("exp",1,1,function(){return Math.pow(Math.E,this.p[0].value())}),qe.f.sqrt=new qe("sqrt",1,1,function(){return Math.sqrt(this.p[0].value())}),qe.f.log=new qe("log",2,2,function(){return Math.log(this.p[0].value())/(this.p[1].value()?Math.log(this.p[1].value()):1)}),qe.f.ln=new qe("ln",1,1,function(){return Math.log(this.p[0].value())}),qe.f.sin=new qe("sin",1,1,function(){return Math.sin(this.p[0].value())}),qe.f.cos=new qe("cos",1,1,function(){return Math.cos(this.p[0].value())}),qe.f.id=new qe("id",1,1,function(){return this.p[0].value().id()}),qe.f.labels=new qe("labels",1,1,function(){return this.p[0].value().getLabels()}),qe.f.type=new qe("type",1,1,function(){return this.p[0].value().getType()}),qe.f.startnode=new qe("startnode",1,1,function(){return this.p[0].value().startNode()}),qe.f.endnode=new qe("endnode",1,1,function(){return this.p[0].value().endNode()}),qe.f.properties=new qe("properties",1,1,function(){return this.p[0].value().getProperties()}),qe.f.exists=new qe("exists",1,1,function(){return null!=this.p[0].value()}),qe.f.keys=new qe("keys",1,1,function(){try{return this.p[0].value().getKeys()}catch(t){}return Object.keys(this.p[0].value())}),qe.f.nodes=new qe("nodes",1,1,function(){return this.p[0].value().getNodes()}),qe.f.relationships=new qe("relationships",1,1,function(){return this.p[0].value().getRelationships()}),qe.f.head=new qe("head",1,1,function(){return this.p[0].value().shift?this.p[0].value().shift():null}),qe.f.last=new qe("last",1,1,function(){return 0<this.p[0].value().length?this.p[0].value()[this.p[0].value().length-1]:null}),qe.f.size=new qe("size",1,1,function(){return this.p[0].value().length}),qe.f.object_lookup=new qe("object_lookup",2,2,function(){if(this.p[0].value().getProperty)return this.p[0].value().getProperty(this.p[1].value());try{return this.p[0].value()[this.p[1].value()]}catch(t){}return null}),qe.f.array_lookup=new qe("array_lookup",2,2,function(){try{return this.p[0].value()[this.p[1].value()]}catch(t){}return null}),qe.f.split=new qe("split",2,2,function(){return Xe(this.p[0].value().split(this.p[1].value()))},_e),qe.f.join=new qe("join",1,2,function(){var t=null!=this.p[1]&&this.p[1].value()||",";return this.p[0].value().join(t)}),qe.f.trim=new qe("trim",1,1,function(){return this.p[0].value().trim()}),qe.f.range=new qe("range",2,3,function(){var t=parseInt(this.p[0].value()),e=parseInt(this.p[1].value()),n=null!=this.p[2]&&parseInt(this.p[2].value())||1;if(0==n)throw"Zero step-size not allowed";if(n<0&&0<e&&t<e)throw"Negative step-size and positive end of range not allowed.";if(0<n&&e<0)throw"Positive step-size and negative end of range not allowed.";if(e<t&&0<n)throw"End of range smaller than start of range and positive step-size not allowed.";for(var i=[],r=t;r!=e;r+=n)i.push(r);return Xe(i)},_e),qe.f.lower=new qe("lower",1,1,function(){return this.p[0].value().toLowerCase()}),qe.f.upper=new qe("upper",1,1,function(){return this.p[0].value().toUpperCase()}),qe.f.toint=new qe("toint",1,1,function(){return parseInt(this.p[0].value())}),qe.f.tofloat=new qe("tofloat",1,1,function(){return parseFloat(this.p[0].value())}),qe.f.tostring=new qe("tostring",1,1,function(){try{return this.p[0].value().toString()}catch(t){}return this.p[0].value()+""}),qe.f.todate=new qe("todate",1,1,function(){return new Date(this.p[0].value())}),qe.f.coalesce=new qe("coalesce",2,2,function(){return null==this.p[0].value()?this.p[1].value():this.p[0].value()}),qe.f.round=new qe("round",1,1,function(){return Math.round(this.p[0].value())}),qe.f.rand=new qe("rand",0,0,function(){return Math.random()}),qe.f.rand.non_deterministic=!0,qe.f.timestamp=new qe("timestamp",0,0,function(){return new Date}),qe.f.not=new qe("not",1,1,function(){return!this.p[0].value()}),qe.trie=p(qe.f),qe.latestParsed=null,qe.isFunction=function(t,e){return g(qe,qe.trie,t,e)},(Qe.f={}).sum=new Qe("sum",1,1,function(){this.getGroupBy().getReducer(this.getReducerId()).result||(this.getGroupBy().getReducer(this.getReducerId()).result=0)},function(){return this.getGroupBy().getReducer(this.getReducerId()).result||new Number(0)},function(){this.initializeIfNecessary(),this.getGroupBy().getReducer(this.getReducerId()).result+=this.p[0].value()}),Qe.f.barchart=new Qe("barchart",1,1,function(){this.getGroupBy().getReducer(this.getReducerId()).result||(this.getGroupBy().getReducer(this.getReducerId()).result={})},function(){return P(this.getGroupBy().getReducer(this.getReducerId()).result)},function(){this.initializeIfNecessary();var t=this.p[0].value().groupByKey&&this.p[0].value().groupByKey()||this.p[0].value();null==this.getGroupBy().getReducer(this.getReducerId()).result[t]&&(this.getGroupBy().getReducer(this.getReducerId()).result[t]=0),this.getGroupBy().getReducer(this.getReducerId()).result[t]++}),Qe.f.histogram=new Qe("histogram",1,2,function(){this.getGroupBy().getReducer(this.getReducerId()).result||(this.getGroupBy().getReducer(this.getReducerId()).result={values:[],histogram:null})},function(){var t=this.getGroupBy().getReducer(this.getReducerId()).result;if(null==t.histogram){for(var e=this.p[1]&&this.p[1].value()||10,n=t.values[0],i=t.values[0],r=new Array(e).fill(0),o=0;o<t.values.length;o++)t.values[o]<n&&(n=t.values[o]),t.values[o]>i&&(i=t.values[o]);var u=(i-n)/e;for(o=0;o<t.values.length;o++)r[Math.floor(t.values[o]/u)]++;t.histogram=new Array(e);var s=n;for(o=0;o<e;o++)t.histogram[o]={label:"["+s+", "+(s+u)+">",value:r[o],from:s,to:s+u},s+=u}return Xe(t.histogram)},function(){this.initializeIfNecessary(),this.getGroupBy().getReducer(this.getReducerId()).result.values.push(this.p[0].value())}),Qe.f.min=new Qe("min",1,1,function(){},function(){return this.getGroupBy().getReducer(this.getReducerId()).result},function(){(null==this.getGroupBy().getReducer(this.getReducerId()).result||this.p[0].value()<this.getGroupBy().getReducer(this.getReducerId()).result)&&(this.getGroupBy().getReducer(this.getReducerId()).result=this.p[0].value())}),Qe.f.max=new Qe("max",1,1,function(){},function(){return this.getGroupBy().getReducer(this.getReducerId()).result},function(){(null==this.getGroupBy().getReducer(this.getReducerId()).result||this.p[0].value()>this.getGroupBy().getReducer(this.getReducerId()).result)&&(this.getGroupBy().getReducer(this.getReducerId()).result=this.p[0].value())}),Qe.f.count=new Qe("count",1,1,function(){this.getGroupBy().getReducer(this.getReducerId()).result||(this.distinct()?this.distinct()&&(this.getGroupBy().getReducer(this.getReducerId()).result={}):this.getGroupBy().getReducer(this.getReducerId()).result=0)},function(){return this.distinct()?this.distinct()?Object.keys(this.getGroupBy().getReducer(this.getReducerId()).result).length:void 0:this.getGroupBy().getReducer(this.getReducerId()).result||new Number(0)},function(){if(this.initializeIfNecessary(),this.distinct()){if(this.distinct()){var t=this.p[0].value().groupByKey&&this.p[0].value().groupByKey()||this.p[0].value();t=JSON.stringify(t),null==this.getGroupBy().getReducer(this.getReducerId()).result[t]&&(this.getGroupBy().getReducer(this.getReducerId()).result[t]=!0)}}else this.getGroupBy().getReducer(this.getReducerId()).result+=1}),Qe.f.stdev=new Qe("stdev",1,1,function(){this.getGroupBy().getReducer(this.getReducerId()).result||(this.getGroupBy().getReducer(this.getReducerId()).result=[])},function(){for(var t,e=0,n=this.getGroupBy().getReducer(this.getReducerId()).result,i=0;i<n.length;i++)e+=n[i];t=e/n.length;for(i=e=0;i<n.length;i++)e+=Math.pow(n[i]-t,2);return Math.sqrt(e/(n.length-1))},function(){this.initializeIfNecessary(),this.getGroupBy().getReducer(this.getReducerId()).result.push(this.p[0].value())}),Qe.f.collect=new Qe("collect",1,1,function(){this.getGroupBy().getReducer(this.getReducerId()).result||(this.distinct()?this.distinct()&&(this.getGroupBy().getReducer(this.getReducerId()).result={}):this.getGroupBy().getReducer(this.getReducerId()).result=Xe([]))},function(){return this.distinct()?this.distinct()?Xe(Object.values(this.getGroupBy().getReducer(this.getReducerId()).result)):void 0:this.getGroupBy().getReducer(this.getReducerId()).result||Xe([])},function(){this.initializeIfNecessary();var t=this.p[0].value();if(null!=t||null!=t)if(this.distinct()){if(this.distinct()){var e=this.p[0].value().groupByKey&&this.p[0].value().groupByKey()||this.p[0].value();e=JSON.stringify(e),null==this.getGroupBy().getReducer(this.getReducerId()).result[e]&&(this.getGroupBy().getReducer(this.getReducerId()).result[e]=this.p[0].value())}}else this.getGroupBy().getReducer(this.getReducerId()).result.push(this.p[0].value())},_e),Qe.trie=p(Qe.f),Qe.latestParsed=null,Qe.isAggregateFunction=function(t,e){return g(Qe,Qe.trie,t,e)};var w,Ye=new t(this),Ze=new function(t){var n,e,i=t,r=[],o={},u=[],s={nodes:{},relationships:{}},a=0,c=0,h=[],f=void 0;this.addOperation=function(t){if(this.context()&&"Return"==this.context().type())throw"There can only be one return statement and it must be last in the query.";this.context()&&this.context().setNextOperation(t),r.push(t)},this.operations=function(){return r},this.context=function(){return f||r[r.length-1]},this.setContext=function(t){f&&h.push(f),f=t},this.resetContext=function(){f=h.pop()},this.addVariable=function(t,e){if(n=new d(e,t),o[t])throw"Variable `"+t+"` already declared.";o[t]=n},this.debugVariables=function(){for(var t in o)console.log('Variable "'+t+'":'),console.log(JSON.stringify(o[t].value()))},this.variables=function(){return Object.values(o)},this.getVariable=function(t){if(!o[t])throw"Variable `"+t+"` has not been declared.";return o[t]},this.hasVariable=function(t){return null!=o[t]},this.getLastVariable=function(){return n},this.setPropertyKey=function(t){e=t},this.getPropertyKey=function(){return e},this.clear=function(){r=[],o={},variableList=[],e=n=void 0,u=[],c=a=0,s={nodes:{},relationships:{}}},this.engine=function(){return i},this.results=function(){return l(),{output:u,graph:{nodes:Object.values(s.nodes),links:Object.values(s.relationships)},stats:{nodesAdded:a,relationshipsAdded:c}}},this.addOutputRecord=function(){u.push({})},this.addOutputEntry=function(t,e,n){var i=t;null!=u[u.length-1][i]&&(i+=n),this.addOutputEntryToGraph(e),u[u.length-1][i]=y(e)};var l=function(){var t,e=[];for(var n in s.relationships)t=s.relationships[n],s.nodes[t.source]&&s.nodes[t.target]||e.push(n);for(var i=0;i<e.length;i++)delete s.relationships[e[i]]};this.addOutputEntryToGraph=function(t){if(t&&t.constructor==T)null==s.nodes[t.id()]&&(s.nodes[t.id()]=y(t));else if(t&&t.constructor==B){if(null==s.relationships[t.id()]){var e=t.getObject().toObject();e.source=e.fromNode.id(),e.target=e.toNode.id(),s.relationships[t.id()]=y(e)}}else if(t&&t.constructor==Array)for(var n=0;n<t.length;n++)this.addOutputEntryToGraph(t[n])},this.setNodesAdded=function(t){a=t},this.setRelationshipsAdded=function(t){c=t},this.getNodesAdded=function(){return a},this.getRelationshipsAdded=function(){return c}}(this),$e=new function(t){function r(){h=!0}var i,c=t,e=void 0,o=0,n="",u=!1,s="(): {}\"',.\n+-/*^[]=<>!",a={},h=!1;this.statementText=function(){return i},this.position=function(){return o};var f=0;function l(t){if(Ae()){if(t&&c.pattern(),c.node(),H(!0)){var e=fe(),n=z(),i=W();if(n||i){if(c.variableExists(e))throw"It is not allowed to create a new node in this context.";c.variable(e)}else if(c.variableExists(e)){var r=c.getVariable(e).getObject();if(!r.isNode())throw"Variable `"+e+"` is bound to a "+r.type()+".";c.lastObject().setReferredNode(r)}else c.variable(e)}else z(),W();if(!Te())throw Ce("Expecting closing parentheses.");return!0}return!1}function d(){if(be()){if("Merge"==c.operation()||"Create"==c.operation())throw"Variable path length not supported in this context.";if(c.context().setHasVariablePathLength(),se()&&c.context().setPathLengthFrom(parseInt(fe())),me()){if(!me())throw Ce('Expected "."');se()&&c.context().setPathLengthTo(parseInt(fe()))}return!0}return!1}function p(){var t=de();if(ge()){if(c.relationship(),t&&c.leftDirection(),Ve()){if(H(!0)){var e=fe(),n=J(),i=W(),r=d();if(n||i||r){if(c.variableExists(e))throw"It is not allowed to create a new relationship in this context.";c.variable(e)}else if(c.variableExists(e)){var o=c.getVariable(e).getObject();if(!o.isRelationship())throw"Variable `"+e+"` is bound to a "+o.type()+".";c.lastObject().setReferredRelationship(o)}else c.variable(e)}else J(),W(),d();if(!je())throw Ce("Expected closing square bracket.");if(!ge())throw Ce("Expected relationship line.");return pe()&&c.rightDirection(),!0}throw Ce("Expected opening square bracket.")}return!1}function g(t){var e=void 0;if(H(!0)){if(Le(),t&&Oe())throw Ce("Path variable not allowed in this context.");if(e=fe(),!Oe())throw Ce("Expected variable assignment.");Le()}if(l(!0)){for(e&&Ze.addVariable(e,Ze.context().getLast().getPattern());p();)if(!l())throw Ce("Expecting node pattern.");return!0}return!1}!function(){for(var t=0;t<s.length;t++)a[s[t]]=!0}(),this.parse=function(t){i=t,n="",h=!1,f=o=0,v()};var v=function(){if((w()||A()||P()||T()||m()||x()||y())&&v(),le())throw Ce("Expected keyword.")},y=function(){return Le(),!!Ft()&&(j(),c.expression(),tt(),S(),!0)},w=function(){if(Le(),Gt()){if(Le(),_t()){if(Le(),Dt(!0)&&(Le(),!Ut()))throw Ce("Expected HEADERS-keyword.");if(Le(),!zt())throw Ce("Expected FROM-keyword.");if(j(),c.expression(),!$())throw Ce("Expected alias.");b()}else{if(!Ht())throw Ce("Expected CSV- or JSON-keyword.");if(Le(),!zt())throw Ce("Expected FROM-keyword.");if(j(),c.expression(),!$())throw Ce("Expected alias.")}return!0}return!1},b=function(){if(Le(),Wt()){if(Le(),!X())throw Ce("Expected single- or doublequoted string.");c.statement().context().setFieldTerminator(fe())}},m=function(){return Le(),!(!Dt()||!R(!0))&&(S(),!0)},x=function(){return Le(),!!Mt()&&R()},R=function(t){do{if(Le(),be())vt();else if(j(),c.expression(),!Z()&&t&&!c.lastObject().hasKey())throw Ce("Expression in WITH must be aliased (use AS).")}while(Ie());if(B(),Le(),V(),Le(),Ct()){if(Le(),!U())throw Ce("Expected table name.");c.insertInto(fe())}return!0},N=function(t){var e,n=t,i=!1;if(ce(),Ae()){if(r(),e=L(),n||(n=wt(new Ge),Ze.setContext(n.element())),n.element().addNode(new ke(Ye)),e&&E(e)&&(n.element().lastObject().setReferredNode(e),i=!0),z()&&(i=!0),W()&&(i=!0),Te())return O(n.element().lastObject())?n:(he(),bt(),!1);if(i)throw Ce("Expecting closing parentheses.");return he(),bt(),!1}return!1},E=function(t){return t.rootObject().constructor==ke},O=function(t){return 0<t.getLabels().length||(0<t.getProperties().length||(!!t.getReferredNode()||0==t.getLabels().length&&0==t.getProperties().length&&!t.getReferredNode()))},I=function(t){var e=de();if(ge()){if(t.element().addRelationship(new Ke(Ye)),e&&t.element().leftDirection(),Ve()){var n;if(H(!0)){var i=fe();if(!c.variableExists(i))throw'Variable "'+i+'" does not exist.';if(!(n=c.getVariable(i).getObject()).isRelationship())throw"Variable `"+i+"` is bound to a "+n.type()+".";t.element().lastObject().setReferredRelationship(c.getVariable(i).getObject())}if(J(),W(),d()&&n)throw"Path expansion not allowed for referred relationship.";if(!je())throw Ce("Expected closing square bracket.");if(!ge())throw Ce("Expected relationship line.");return pe()&&c.rightDirection(),!0}throw Ce("Expected opening square bracket.")}return!1},P=function(){if(Le(),Vt()){if(Le(),!g())throw Ce("Expecting graph pattern.");return B(),S(),!0}return!1},A=function(){if(Le(),Bt()){do{if(Le(),!g())throw Ce("Expecting graph pattern.")}while(Ie());return B(),S(),!0}return!1},T=function(){if(Le(),St()){do{if(Le(),!g())throw Ce("Expecting graph pattern.")}while(Ie());return B(),S(),!0}return!1},B=function(){Kt()&&(j(),c.where($e.getExpression()))},S=function(){if(Le(),qt()){c.setter();do{if(!H(!0))throw Ce("Expected variable.");var t=c.getVariable(fe());if(me()){var e;if(!Q())throw Ce("Expected property key.");if(e=fe(),Le(),!Oe())throw Ce("Expected equals character (=).");Le(),j();var n=$e.getExpression();c.operationContext().addSetter(t,e,n)}else if(z(),t.getObject().constructor!=ke)throw"Can't assign a label to a \""+t.getObject().getType()+'".'}while(Ie())}},V=function(){kt()&&(j(!0),c.limit($e.getExpression()))},j=function(t){var e,n,i=!0;if(n=function(){if(ce(),!Ae())return!1;o--;var e=!1;try{var t=N();if(t){for(;I(t);)if(!N(t))throw Ce("Expecting node pattern.");return t.element().useAsCondition(),Ze.resetContext(),t}}catch(t){throw e=!0,Ze.resetContext(),t}return e||Ze.resetContext(),!1}())i=!1;else if(Ae()){if(Pt(),n=j(t),!Te())throw Ce("Expected closing parentheses.");At()}else if(jt())n=F();else if(Lt())n=G();else if(Y())n=gt(fe());else if(e=C())Nt(e),i=!1;else if(H(!0)){if(t)throw Ce("Variables not allowed within this context.");n=yt(fe())}else if(e=K())n=xt(e);else if(e=k())n=Rt(e);else if(!function(){var t=h;return h=!1,t}())throw Ce("Expected expression");return n&&i&&D(n),Le(),re()&&(It(We.latestParsed),Le(),j()),n},L=function(){$e.addLayer(),j();var t=$e.getExpression();return $e.finishLayer(),t},D=function(t){for(;;)if(me()){if(!Q())throw Ce("Expected property key.");lt(t,fe())}else if(!M(t)){pt();break}},M=function(t){if(Ve()){if(dt(t,L()),!je())throw Ce("Expected closing square bracket.");return!0}return!1},C=function(){if($t()){Le();for(var t=new He;te();){if(t.when(L()),Le(),!ee())throw Ce("Expected THEN keyword");t.then(L()),Le()}if(0==t.whenCount())throw Ce("Expected WHEN keyword");if(Le(),ne()&&t.else(L()),Le(),!ie())throw Ce("Expected END keyword");return t}return!1},k=function(){if(Be()){var t=new Fe;do{if(Q()){var e=fe();if(!Ee())throw Ce("Expected colon.");t.addEntry(e,L())}}while(Ie());if(!Se())throw Ce("Expected closing curly bracket.");return t}return!1},K=function(){if(Ve()){for(var t=new _e;r(),t.add(L()),Ie(););if(!je())throw Ce("Expected closing bracket.");return t}return!1},G=function(){if(0<f)throw Ce("Not allowed to nest aggregation functions.");if(Ae()){var t=Ot(Qe.latestParsed);if(Pt(),f++,Le(),Qt()&&t.setDistinct(),Le(),Qe.latestParsed.parametric()){for(var e=0;_(),e++,Ie(););try{t.verifyParsedParameterCount(e)}catch(t){throw Ce(t)}}if(!Te())throw Ce("Expected closing parentheses.");return At(),f--,t}throw Ce("Expected opening parentheses.")},F=function(){if(Ae()){var t=Et(qe.latestParsed);if(Pt(),qe.latestParsed.parametric()){for(var e=0;_(),e++,Ie(););try{t.verifyParsedParameterCount(e)}catch(t){throw Ce(t)}}if(!Te())throw Ce("Expected closing parentheses.");return At(),t}throw Ce("Expected opening parentheses.")},_=function(){mt(L())},H=function(t){var e=!t;if(Le(),ye(Me()))return!1;if(Ne())for(;le()&&!Ne();)n+=Me(),o++;else if(!Ne())for(;le()&&!a[Me()];)n+=Me(),o++;return 0<n.length&&(e&&c.variable(fe()),!0)},U=function(){return H(!0)},z=function(){if(Le(),!Ee())return!1;var t="";if(Ne())for(;le()&&!Ne();)t+=Me(),o++;else if(!Ne())for(;le()&&!a[Me()];)t+=Me(),o++;if(""==t)throw Ce("Expecting label name.");return c.label(t),z(),!0},J=function(){if(Le(),!Ee())return!1;var t="";if(Ne())for(;le()&&!Ne();)t+=Me(),o++;else if(!Ne())for(;le()&&!a[Me()];)t+=Me(),o++;if(""==t)throw Ce("Expecting type name.");return c.type(t),!0},W=function(){if(Le(),Be()){if(!q())throw Ce("Expecting at least one property.");if(!Se())throw Ce("Expecting closing curly brackets.");return!0}return!1},q=function(){if(!Q())return!1;if(c.propertyKey(fe()),!Ee())throw Ce("Expected colon.");return c.propertyValue(L()),!Ie()||q()},Q=function(){if(Le(),ye(Me()))return!1;if(Ne())for(;le()&&!Ne();)n+=Me(),o++;else if(!Ne())for(;le()&&!a[Me()];)n+=Me(),o++;return 0!=n.length},X=function(){if(xe()){for(u=!0;le()&&!xe();)Pe(),n+=Me(),o++;u=!1}else{if(!Re())return!1;for(u=!0;le()&&!Re();)Pe(),n+=Me(),o++;u=!1}return!0},Y=function(){if(X());else if(ue())n=parseFloat(n);else if(Xt())n=!0;else if(Yt())n=!1;else{if(!Zt())return!1;n=null}return!0},Z=function(){if(Le(),Jt()){if(!H(!0))throw Ce("Expected alias variable key.");return c.as(fe()),!0}return!1},$=function(){if(Le(),Jt()){if(!H(!1))throw Ce("Expected alias variable key.");return c.as(fe()),!0}return!1},tt=function(){if(Le(),Jt()){if(!H(!1))throw Ce("Unwinded collection must be aliased.");return!0}return!1};function et(t,e){var n=t,i=e;this.getObject=function(){return n.statement().getVariable(i).getObject()},this.value=function(t){return n.statement().getVariable(i).value(t)},this.getKey=function(){return i},this.type=function(){return n.statement().getVariable(i).getObject().type()},this.groupByKey=function(){var t=n.statement().getVariable(i).getObject();return t.groupByKey&&t.groupByKey()||t},this.groupByValue=function(){var t=n.statement().getVariable(i).getObject();return t.groupByValue&&t.groupByValue()||t}}function nt(t){var e=t,n=0,i=void 0,r=void 0,o=this,u=this,s=0;this.element=function(){return e},this.precalculate=function(){n=0,i=this.value(),r=this.value,c(a)};var a=function(){if(i&&0==n)return n++,i;if(i&&1==n){var t=i;return i=void 0,n=0,c(r),t}},c=function(t){o.value=t,o.groupByKey=o.value,o.groupByValue=o.value};this.elementValueContext=function(){return u},this.elementValue=function(){return e.value.call(u)},this.type=e.type,this.value=this.elementValue,this.groupByKey=e.groupByKey||this.elementValue,this.groupByValue=e.groupByValue||this.elementValue,this.hasKey=function(){return e.getKey&&e.getKey()},this.parsedParameterCount=function(){return s},this.verifyParsedParameterCount=function(t){e.constructor!=qe&&e.constructor!=Qe||(s=t,e.verifyParsedParameterCount(s))},this.non_deterministic=function(){return e.non_deterministic()},this.mappable=function(){if(e.mappable&&!e.mappable())return!1;if(this.p)for(var t=0;t<this.p.length;t++)if(this.p[t].mappable&&!this.p[t].mappable())return!1;return!0}}function it(t){nt.call(this,t);var e,n,i=!1;this.setReducer=function(t){n=t},this.setGroupBy=function(t){e=t},this.getGroupBy=function(){return e},this.getReducerId=function(){return n},this.initializeIfNecessary=function(){this.initialize()},this.initialize=function(){return this.element().initialize.call(this.elementValueContext())},this.aggregate=function(){return this.element().aggregate.call(this.elementValueContext())},this.value=function(){return this.element().value.call(this.elementValueContext())},this.groupByKey=function(){return this.element().groupByKey.call(this.elementValueContext())},this.groupByValue=function(){return this.element().groupByValue.call(this.elementValueContext())},this.hasKey=function(){return this.element().getKey&&this.element().getKey()},this.distinct=function(){return i},this.setDistinct=function(){i=!0},this.mappable=function(){return!1}}function rt(){return 0==st.length?null:st[st.length-1]}function ot(){return 0==at.length?null:at[at.length-1]}(it.prototype=Object.create(nt.prototype)).constructor=it;var ut=[],st=[],at=[],ct=function(){st=[],at=[]};function ht(t){return st.push(t),rt()}function ft(t){return at.push(t),ot()}this.addLayer=function(){ut.push({output:st,operators:at,rollbackPosition:e}),ct()},this.finishLayer=function(){var t=ut.pop();st=t.output,at=t.operators,e=t.rollbackPosition};var lt=function(t,e){t.lookups||(t.lookups=[]),t.lookups.push({function:qe.f.object_lookup,index:new nt(new Ue(e))})},dt=function(t,e){t.lookups||(t.lookups=[]),t.lookups.push({function:qe.f.array_lookup,index:new nt(e)})},pt=function(){},gt=function(t){return ht({isAtom:!0,v:new nt(new Ue(t))}).v},vt=function(){for(var t=c.statement().context().variables(),e=0;e<t.length;e++)yt(t[e].getObjectKey()),c.expression()},yt=function(t){return ht({isAtom:!0,isVariable:!0,v:new nt(new et(c,t))}).v},wt=function(t){return ht({isAtom:!0,v:new nt(t)}).v},bt=function(){rt().v.element().constructor==Ge&&st.pop()},mt=function(t){return ht({isAtom:!0,v:new nt(t)}).v},xt=function(t){return ht({isAtom:!0,v:new nt(t)}).v},Rt=function(t){return ht({isAtom:!0,v:new nt(t)}).v},Nt=function(t){return ht({isAtom:!0,v:new nt(t)}).v},Et=function(t){return ft({isFunction:!0,v:new nt(t)}).v},Ot=function(t){return ft({isAggregateFunction:!0,isFunction:!0,v:new it(t)}).v},It=function(t){for(;0<at.length&&(at.slice(-1)[0].isOperator||at.slice(-1)[0].isFunction)&&(e=t,n=at.slice(-1)[0].v.element(),e.leftAssociativity()&&e.precedence()<=n.precedence()||e.rightAssociativity()&&e.precedence()<n.precedence());)st.push(at.pop());var e,n;return ft({isOperator:!0,v:new nt(t)}).v},Pt=function(){ft({leftParentheses:!0})},At=function(){for(;0<at.length&&!at.slice(-1)[0].leftParentheses;)st.push(at.pop());at.pop()};function Tt(t,e,n){var i=!n;return e||Le(),Me()==t&&(i&&o++,!0)}this.getExpression=function(){return function(){for(;0<at.length;)st.push(at.pop());for(var t,e,n=Xe([]),i=[],r=!1;0<st.length;){if((e=st.shift()).isOperator)e.v.rhs=n.pop().v,e.v.lhs=n.pop().v;else if(e.isFunction){e.v.p=[];for(var o=0;o<e.v.parsedParameterCount();o++)e.v.p.unshift(n.pop().v);e.isAggregateFunction&&(t=t||[],e.v.p=e.v.p,t.push(e.v)),e.v.element().non_deterministic&&(r=!0)}if(e.isVariable&&i.push(e.v.element().getKey()),e.v.lookups)for(var u,s,a=e.v.lookups;a&&0<a.length;)s=e.v,u=a.shift(),e.v=new nt(u.function),e.v.p=[s,u.index];n.push(e)}return ct(),0==n.length?null:new ze(n.pop().v,"expr",t,c.statement().context(),i,r)}()};var Bt=function(){return oe(Je.f.CREATE)},St=function(){return oe(Je.f.MATCH)},Vt=function(){return oe(Je.f.MERGE)},jt=function(){var t;return 0<(t=qe.isFunction(i,o))&&(o+=t,!!Ae(!0,!0)||(o-=t,!1))},Lt=function(){var t;return 0<(t=Qe.isAggregateFunction(i,o))&&(o+=t,!0)},Dt=function(t){return oe(Je.f.WITH,t)},Mt=function(){return oe(Je.f.RETURN)},Ct=function(){return oe(Je.f.INTO)},kt=function(){return oe(Je.f.LIMIT)},Kt=(Mt=function(){return oe(Je.f.RETURN)},function(){return oe(Je.f.WHERE)}),Gt=function(){return oe(Je.f.LOAD)},Ft=function(){return oe(Je.f.UNWIND)},_t=function(){return oe(Je.f.CSV)},Ht=function(){return oe(Je.f.JSON)},Ut=function(){return oe(Je.f.HEADERS)},zt=function(){return oe(Je.f.FROM)},Jt=function(){return oe(Je.f.AS)},Wt=function(){return oe(Je.f.FIELDTERMINATOR)},qt=function(){return oe(Je.f.SET)},Qt=function(){return oe(Je.f.DISTINCT)},Xt=function(){return oe(Je.f.TRUE)},Yt=function(){return oe(Je.f.FALSE)},Zt=function(){return oe(Je.f.NULL)},$t=function(){return oe(Je.f.CASE)},te=function(){return oe(Je.f.WHEN)},ee=function(){return oe(Je.f.THEN)},ne=function(){return oe(Je.f.ELSE)},ie=function(){return oe(Je.f.END)},re=function(){var t;return 0<(t=We.isOperator(i,o))&&(o+=t,!0)},oe=function(t,e){var n;return 0<(n=Je.isKeyWord(i,o))&&Je.latestParsed===t&&(e||Je.latestParsed.action(c),o+=n,!0)},ue=function(){Le();var t=!1;if(ve()&&(ae(),t=!0),!we()){if(t)throw Ce("Expected number.");return!1}for(ae();we();)ae();if(me()){if(ae(),!we())throw Ce("Expected one or more integers after decimal point.");for(ae();we();)ae()}return Le(),!0},se=function(){if(Le(),!we())return!1;for(ae();we();)ae();return Le(),!0},ae=function(){n+=De()},ce=function(){e=o},he=function(){null==e||o<e||(o-=o-e,n="",e=void 0)},fe=function(){var t=n;return n="",t},le=function(){return o<i.length},de=function(){return Tt("<")},pe=function(){return Tt(">")},ge=function(){return Tt("-")},ve=function(){return Tt("-")},ye=function(t){return!isNaN(parseInt(t))},we=function(){var t=ye(Me());return t&&o++,t},be=function(){return Tt("*")},me=function(){return Tt(".")},xe=function(){return("\\"!=De()||"'"!=Me()||!u)&&Tt("'",!0)},Re=function(){return("\\"!=De()||'"'!=Me()||!u)&&Tt('"',!0)},Ne=function(){return("\\"!=De()||"`"!=Me()||!u)&&Tt("`",!0)},Ee=function(){return Tt(":")},Oe=function(){return Tt("=")},Ie=function(){return Tt(",")},Pe=function(){return Tt("\\",!0)},Ae=function(t,e){return Tt("(",e,t)},Te=function(){return Tt(")")},Be=function(){return Tt("{")},Se=function(){return Tt("}")},Ve=function(){return Tt("[")},je=function(){return Tt("]")},Le=function(){for(;" "==Me()||"\n"==Me()||"\t"==Me()||"\r"==Me();)o++},De=function(){return i.charAt(o-1)},Me=function(){return i.charAt(o)},Ce=function(t){return ct(),t+' Parsed "'+i.substring(0,o)+'". Got "'+Me()+'"'}}(this);this.execute=function(t,e,o){Ze.clear();var u=arguments.callee;try{self.onerror=function(t,e,n,i,r){console.log(t),o(t),v(u)}}catch(t){}try{$e.parse(t),this.run(e)}catch(t){o(t),v(u),console.log(t)}},this.addGraph=function(t,e){for(var n=0;n<t.length;n++)Ye.addNode(t[n]);for(n=0;n<e.length;n++)Ye.addRelationship(e[n])},this.resetDataBase=function(){Ye=new t(this)},this.setDataDownloadProxy=function(t){w=t},this.getDataDownloadProxy=function(){return w},this.db=function(){return Ye},this.optional=function(){return this},this.create=function(){return Ze.addOperation(new i(Ze)),this},this.match=function(){return Ze.addOperation(new r(Ze)),this},this.pattern=function(){return Ze.context().addPattern(),this},this.node=function(){return Ze.context().addNode(new ke(Ye)),this},this.relationship=function(){return Ze.context().addRelationship(new Ke(Ye)),this},this.expression=function(){return Ze.context().expression($e.getExpression()),this},this.variable=function(t){return Ze.context().variable(t),this},this.variableExists=function(t){return Ze.hasVariable(t)},this.getVariable=function(t){return Ze.getVariable(t)},this.lastObject=function(){return Ze.context().getLast()},this.label=function(t){return Ze.context().getLast().setLabel(t),this},this.type=function(t){return Ze.context().getLast().setType(t),this},this.readProperty=function(t){return Ze.context().getLast().readProperty(t),this},this.propertyValue=function(t){return Ze.context().getLast().setProperty(Ze.getPropertyKey(),t),this},this.propertyKey=function(t){return Ze.setPropertyKey(t),this},this.as=function(t){return Ze.context().getLast().setAlias(t),this},this.leftDirection=function(){return Ze.context().getLast().setLeftDirection(!0),this},this.setter=function(){return Ze.addOperation(new n),this},this.relStart=function(){return this},this.relMiddle=function(){return this},this.relEnd=function(){return this},this.rightDirection=function(){return Ze.context().getLast().setRightDirection(!0),this},this.variableProperty=function(t){return this},this.equals=function(){return this},this.constant=function(t){return Ze.context().constant(t),this},this.load=function(){return Ze.addOperation(new l(Ze)),this},this.csv=function(){return Ze.context().csv(),this},this.json=function(){return Ze.context().json(),this},this.headers=function(){return Ze.context().headers(),this},this._with=function(){return Ze.addOperation(new h(Ze)),this},this._return=function(){return Ze.addOperation(new s(Ze)),this},this.into=function(){return this},this.insertInto=function(t){Ze.addOperation(new e(Ze.engine().db(),t))},this.merge=function(){return Ze.addOperation(new c(Ze)),this},this.unwind=function(){return Ze.addOperation(new f(Ze)),this},this.limit=function(t){return Ze.context().limit(t),this},this.where=function(t){return Ze.context().where(t),this},this.statement=function(){return Ze},this.operation=function(){return Ze.context().type()},this.context=function(){return Ze.context().getLast()},this.operationContext=function(){return Ze.context()},this.run=function(t){switch(Ze.context().type()){case"Match":case"With":throw"A "+Ze.context().type()+"-statement cannot conclude the query."}Ze.operations()[0].run(t)}}var Cypher_context_is_worker=!this.document,isNodeJS=!1,Cypher_script_path=function(){if(Cypher_context_is_worker)return"";var t=this.document.getElementsByTagName("script");return t[t.length-1].src}();try{module&&(isNodeJS=!0)}catch(t){isNodeJS=!1}function Cypher(t){var e=!t||!t.runInWebWorker;if(Cypher_context_is_worker&&!isNodeJS)try{var i=new CypherJS;t&&t.dataDownloadProxy&&i.setDataDownloadProxy(t.dataDownloadProxy),self.onmessage=function(t){var e=t.data,n=e.action;switch(n){case"query":return void i.execute(e.statementText,function(t){self.postMessage({action:n,success:!0,results:t})},function(t){self.postMessage({action:n,error:!0,message:t})});case"addGraph":try{i.addGraph(e.nodes,e.edges)}catch(t){return void self.postMessage({action:n,error:!0,message:t})}return void self.postMessage({action:n,success:!0});case"resetDataBase":return i.resetDataBase(),void self.postMessage({action:n})}}}catch(t){}else if(Cypher_context_is_worker||e||isNodeJS){if(isNodeJS||!isNodeJS&&!Cypher_context_is_worker&&e){i=new CypherJS;t&&t.dataDownloadProxy&&i.setDataDownloadProxy(t.dataDownloadProxy),this.execute=function(t,e,n){i.execute(t,e,n)}}}else{var r,o,u=new Worker(Cypher_script_path);u.onmessage=function(t){var e=t.data;switch(e.action){case"query":case"addGraph":return void(e.success?r(e.results):e.error&&o(e.message));case"resetDataBase":return void(r&&r())}},this.execute=function(t,e,n){r=e,o=n,u.postMessage({action:"query",statementText:t})},this.addGraph=function(t,e,n,i){r=n,o=i,u.postMessage({action:"addGraph",nodes:t,edges:e})},this.resetDataBase=function(t){t?r=_successCallback:t||(r=function(){}),u.postMessage({action:"resetDataBase"})}}}Object.values||(Object.values=function(t){var e=[];for(var n in t)e.push(t[n]);return e}),Object.keys||(Object.keys=function(t){var e=[];for(var n in t)e.push(n);return e}),Array.prototype.fill||(Array.prototype.fill=function(t){for(var e=Object(this),n=0;n<e.length;n++)e[n]=t;return e}),Array.prototype.concat||(Array.prototype.concat=function(t){for(var e=Object(this),n=new Array(e.length+t.length),i=0;i<e.length;i++)n[i]=e[i];for(;i<n.length;i++)n[i]=t[i-e.length];return n}),Cypher_context_is_worker&&new Cypher;try{module.exports={Cypher:Cypher}}catch(t){}